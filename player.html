<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neon Media Player</title>
<style>
:root{
 --bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.3);--text:#e6faff
}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#081020,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center}
.player{width:350px;background:rgba(10,20,40,.6);border-radius:20px;padding:16px;box-shadow:0 0 40px var(--soft);border:1px solid var(--soft)}
.title{text-align:center;color:var(--neon);letter-spacing:2px;margin-bottom:8px}
input[type=file]{width:100%;margin-bottom:8px}
audio,video{width:100%;display:none;border-radius:12px;margin-top:6px}
canvas{width:100%;height:60px;margin-top:6px}
.controls{display:flex;gap:6px;margin-top:8px}
button{flex:1;height:40px;background:transparent;border:1px solid var(--neon);color:var(--neon);border-radius:12px}
.slider{margin-top:6px;font-size:12px}
.time{display:flex;justify-content:space-between;font-size:11px;opacity:.8}
.playlist{margin-top:8px;max-height:110px;overflow-y:auto;font-size:13px}
.track{padding:6px;border-radius:6px;cursor:pointer}
.track.active{background:var(--soft);color:var(--neon)}
</style>
</head>
<body>
<div class="player">
<div class="title">NEON MEDIA PLAYER</div>
<input id="files" type="file" multiple accept="audio/*,video/mp4" />
<audio id="audio"></audio>
<video id="video" playsinline></video>
<canvas id="viz"></canvas>
<div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
<input id="seek" type="range" min="0" value="0" />
<div class="controls">
<button id="prev">⏮</button><button id="play">▶</button><button id="pause">⏸</button><button id="next">⏭</button>
</div>
<div class="slider">Громкость
<input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
</div>
<div id="playlist" class="playlist"></div>
</div>
<script>
const filesInput=files=document.getElementById('files')
const audio=document.getElementById('audio')
const video=document.getElementById('video')
const playlistEl=document.getElementById('playlist')
const volume=document.getElementById('volume')
const seek=document.getElementById('seek')
const cur=document.getElementById('cur')
const dur=document.getElementById('dur')
const canvas=document.getElementById('viz')
const ctx=canvas.getContext('2d')
let playlist=[],current=-1,active=null,ac=null,analyser=null

function fmt(t){if(!t)return'0:00';const m=Math.floor(t/60),s=Math.floor(t%60);return m+':'+(s<10?'0':'')+s}

function setupAudioCtx(){
  if(ac) return;
  ac = new AudioContext();
  analyser = ac.createAnalyser();
  analyser.fftSize = 64;
}

// iOS: ОДИН MediaElementSource на media-элемент
function connect(player){
  setupAudioCtx();

  if (!player._mediaSource) {
    player._mediaSource = ac.createMediaElementSource(player);
  }

  try { player._mediaSource.disconnect(); } catch(e){}
  try { analyser.disconnect(); } catch(e){}

  player._mediaSource.connect(analyser);
  analyser.connect(ac.destination);
}

function loadTrack(i){const f=playlist[i];if(!f)return;document.querySelectorAll('.track').forEach((t,n)=>t.classList.toggle('active',n===i));audio.pause();video.pause();audio.style.display='none';video.style.display='none';const url=URL.createObjectURL(f);active=f.type.startsWith('video')?video:audio;active.src=url;active.style.display='block';active.volume=volume.value;connect(active);active.play();current=i}
filesInput.onchange=()=>{playlist=[...filesInput.files];playlistEl.innerHTML='';playlist.forEach((f,i)=>{const d=document.createElement('div');d.className='track';d.textContent=f.name;d.onclick=()=>loadTrack(i);playlistEl.appendChild(d)})}
document.getElementById('play').onclick=()=>active&&active.play()
document.getElementById('pause').onclick=()=>active&&active.pause()
document.getElementById('next').onclick=()=>playlist.length&&loadTrack((current+1)%playlist.length)
document.getElementById('prev').onclick=()=>playlist.length&&loadTrack((current-1+playlist.length)%playlist.length)
volume.oninput=()=>{audio.volume=volume.value;video.volume=volume.value}
seek.oninput=()=>active&&(active.currentTime=seek.value)
function tick(){if(active){seek.max=active.duration||0;seek.value=active.currentTime||0;cur.textContent=fmt(active.currentTime);dur.textContent=fmt(active.duration)}drawViz();requestAnimationFrame(tick)}
function drawViz(){if(!analyser)return;const w=canvas.width=canvas.offsetWidth,h=canvas.height=canvas.offsetHeight;const data=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(data);ctx.clearRect(0,0,w,h);data.forEach((v,i)=>{const bw=w/data.length;ctx.fillStyle='rgba(0,246,255,.8)';ctx.fillRect(i*bw,h,h-(v/255*h),bw-1)})}
audio.onended=video.onended=()=>document.getElementById('next').click()
tick()
</script>
</body>
</html>
