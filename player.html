<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Neon Audio Player</title>

<meta name="theme-color" content="#05080f" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{--bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.25);--text:#e6faff}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;-webkit-tap-highlight-color:transparent}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0a1633,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center;overscroll-behavior:none}
.player{width:360px;max-width:94vw;background:linear-gradient(180deg,rgba(20,40,80,.7),rgba(10,20,40,.9));backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:26px;padding:20px;box-shadow:0 0 60px rgba(0,246,255,.15);border:1px solid rgba(0,246,255,.3)}
.title{text-align:center;color:var(--neon);letter-spacing:3px;font-weight:700;margin-bottom:15px;text-shadow:0 0 10px var(--soft)}
.file-btn{display:flex;align-items:center;justify-content:center;width:100%;padding:14px;border-radius:18px;border:1px dashed var(--neon);color:var(--neon);margin-bottom:15px;cursor:pointer;background:rgba(0,246,255,0.05);transition:0.2s}
.file-btn:active{background:rgba(0,246,255,0.15)}
input[type=file]{display:none}
canvas{width:100%;height:60px;border-radius:12px;background:rgba(0,0,0,.3);margin-bottom:10px}
.controls{display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:12px}
.ctrl-btn{width:56px;height:56px;border-radius:50%;border:1px solid var(--neon);background:rgba(0,246,255,.05);display:flex;align-items:center;justify-content:center;transition:.15s;cursor:pointer}
.ctrl-btn.play{width:72px;height:72px}
.ctrl-btn svg{width:26px;height:26px;fill:var(--neon)}
.ctrl-btn:active{transform:scale(.92);box-shadow:0 0 20px var(--neon)}
.ctrl-btn.play.playing{background:rgba(0,246,255,.2);box-shadow:0 0 25px var(--soft)}
.time{display:flex;justify-content:space-between;font-size:12px;opacity:.7;margin-top:6px;font-variant-numeric:tabular-nums}
input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:6px;outline:none;background:rgba(255,255,255,.15);margin:0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--neon);box-shadow:0 0 10px var(--neon);margin-top:-6px;position:relative;z-index:2}
input[type=range]::-webkit-slider-runnable-track{height:6px;border-radius:6px}
.playlist{margin-top:15px;max-height:180px;overflow-y:auto;font-size:14px;border-top:1px solid rgba(255,255,255,0.1);padding-top:10px}
.track{padding:12px;border-radius:10px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px}
.track.active{background:rgba(0,246,255,.15);color:var(--neon);font-weight:500}
.slider{font-size:12px;margin-top:15px;display:flex;align-items:center;gap:10px;opacity:.8}
.slider input{flex:1}
</style>
</head>

<body>
<div class="player">
  <div class="title">NEON VIBES</div>

  <label class="file-btn">
    üìÇ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏
    <input id="files" type="file" multiple accept="audio/*" />
  </label>

  <audio id="audio" playsinline webkit-playsinline preload="metadata"></audio>
  <canvas id="viz"></canvas>

  <div class="time">
    <span id="cur">0:00</span>
    <span id="dur">0:00</span>
  </div>
  <div style="padding: 10px 0;">
      <input id="seek" type="range" min="0" value="0" />
  </div>

  <div class="controls">
    <button id="prev" class="ctrl-btn">
      <svg viewBox="0 0 24 24"><polygon points="11,6 5,12 11,18"/><polygon points="19,6 13,12 19,18"/></svg>
    </button>

    <button id="toggle" class="ctrl-btn play">
      <svg id="icon" viewBox="0 0 24 24"><polygon points="8,5 19,12 8,19"/></svg>
    </button>

    <button id="next" class="ctrl-btn">
      <svg viewBox="0 0 24 24"><polygon points="5,6 11,12 5,18"/><polygon points="13,6 19,12 13,18"/></svg>
    </button>
  </div>

  <div class="slider">
    üîä <input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
  </div>

  <div id="playlist" class="playlist"></div>
</div>

<script>
/* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
const audio = document.getElementById('audio')
const filesEl = document.getElementById('files')
const playlistEl = document.getElementById('playlist')
const seek = document.getElementById('seek')
const volume = document.getElementById('volume')
const cur = document.getElementById('cur')
const dur = document.getElementById('dur')
const toggle = document.getElementById('toggle')
const icon = document.getElementById('icon')
const canvas = document.getElementById('viz')
const ctx = canvas.getContext('2d')

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ */
let playlist = []
let current = 0
let audioCtx, analyser, source
let isVizInit = false

/* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ */
const fmt = t => {
  if (!t || isNaN(t)) return '0:00'
  const m = Math.floor(t / 60)
  const s = Math.floor(t % 60)
  return `${m}:${s < 10 ? '0' + s : s}`
}

/* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Audio Context (–¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞) */
function initAudioContext() {
  if (isVizInit) return
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)()
    analyser = audioCtx.createAnalyser()
    source = audioCtx.createMediaElementSource(audio)
    source.connect(analyser)
    analyser.connect(audioCtx.destination)
    analyser.fftSize = 64
    isVizInit = true
    drawViz()
  } catch (e) {
    console.log("AudioContext –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
  }
}

/* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä */
function drawViz() {
  if (!isVizInit) return
  requestAnimationFrame(drawViz)
  
  // –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —Å–≤–µ—Ä–Ω—É—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ
  if(audio.paused) return 

  const bufferLength = analyser.frequencyBinCount
  const dataArray = new Uint8Array(bufferLength)
  analyser.getByteFrequencyData(dataArray)

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.fillStyle = 'rgba(0, 246, 255, 0.5)'
  
  const barWidth = (canvas.width / bufferLength) * 2.5
  let barHeight
  let x = 0

  for (let i = 0; i < bufferLength; i++) {
    barHeight = dataArray[i] / 255 * canvas.height
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight)
    x += barWidth + 2
  }
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Media Session (–î–ª—è iOS Lock Screen) */
function updateMediaSession() {
  if (!('mediaSession' in navigator) || !playlist[current]) return

  const track = playlist[current]
  
  navigator.mediaSession.metadata = new MediaMetadata({
    title: track.name.replace(/\.[^/.]+$/, ""), // –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    artist: 'Neon Player',
    artwork: [
      { src: 'https://via.placeholder.com/512/05080f/00f6ff?text=MUSIC', sizes: '512x512', type: 'image/png' }
    ]
  })

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
  navigator.mediaSession.setActionHandler('play', () => { togglePlay(true) })
  navigator.mediaSession.setActionHandler('pause', () => { togglePlay(false) })
  navigator.mediaSession.setActionHandler('previoustrack', playPrev)
  navigator.mediaSession.setActionHandler('nexttrack', playNext)
  navigator.mediaSession.setActionHandler('seekto', (details) => {
      audio.currentTime = details.seekTime
      updateUI()
  })
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞ */
function loadIndex(i) {
  if (i < 0 || i >= playlist.length) return
  current = i
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–ª–µ–π–ª–∏—Å—Ç–∞
  document.querySelectorAll('.track').forEach((el, n) => el.classList.toggle('active', n === i))
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
  audio.src = playlist[i].url
  audio.load()
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è iOS
  updateMediaSession()
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª–∞–π–¥–µ—Ä
  seek.value = 0
  seek.style.background = `rgba(255,255,255,.15)`
}

/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º */
async function togglePlay(forceState) {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ (–Ω—É–∂–Ω–æ –¥–ª—è iOS)
  if (!isVizInit) initAudioContext()
  if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume()

  try {
    const shouldPlay = forceState !== undefined ? forceState : audio.paused
    if (shouldPlay) {
      await audio.play()
    } else {
      audio.pause()
    }
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", err)
  }
}

function playNext() {
  const next = (current + 1) % playlist.length
  loadIndex(next)
  togglePlay(true)
}

function playPrev() {
  const prev = (current - 1 + playlist.length) % playlist.length
  loadIndex(prev)
  togglePlay(true)
}

/* –°–æ–±—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
filesEl.onchange = () => {
  const newFiles = [...filesEl.files].map(f => ({
    name: f.name,
    url: URL.createObjectURL(f)
  }))
  
  if (newFiles.length === 0) return

  // –ï—Å–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç –±—ã–ª –ø—É—Å—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∏ —Å—Ä–∞–∑—É –≥—Ä—É–∑–∏–º –ø–µ—Ä–≤—ã–π
  const wasEmpty = playlist.length === 0
  playlist = [...playlist, ...newFiles]
  
  renderPlaylist()
  
  if (wasEmpty) loadIndex(0)
}

function renderPlaylist() {
  playlistEl.innerHTML = ''
  playlist.forEach((t, i) => {
    const d = document.createElement('div')
    d.className = 'track' + (i === current ? ' active' : '')
    d.textContent = t.name
    d.onclick = () => { loadIndex(i); togglePlay(true) }
    playlistEl.appendChild(d)
  })
}

/* –ê—É–¥–∏–æ —Å–æ–±—ã—Ç–∏—è */
toggle.onclick = () => togglePlay()
document.getElementById('next').onclick = playNext
document.getElementById('prev').onclick = playPrev

volume.oninput = () => {
  audio.volume = volume.value
  volume.style.background = `linear-gradient(90deg,var(--neon) ${volume.value*100}%,rgba(255,255,255,.15) ${volume.value*100}%)`
}

function updateUI() {
    if(!audio.duration) return
    seek.max = audio.duration
    seek.value = audio.currentTime
    const p = (audio.currentTime / audio.duration) * 100
    seek.style.background = `linear-gradient(90deg,var(--neon) ${p}%,rgba(255,255,255,.15) ${p}%)`
    cur.textContent = fmt(audio.currentTime)
    dur.textContent = fmt(audio.duration)
}

audio.ontimeupdate = updateUI

seek.oninput = () => {
    audio.currentTime = seek.value
    updateUI()
}

audio.onplay = () => {
  icon.innerHTML = '<rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/>'
  toggle.classList.add('playing')
  // –°–æ–æ–±—â–∞–µ–º iOS, —á—Ç–æ –º—ã –∏–≥—Ä–∞–µ–º
  if('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing"
}

audio.onpause = () => {
  icon.innerHTML = '<polygon points="8,5 19,12 8,19"/>'
  toggle.classList.remove('playing')
  if('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused"
}

audio.onended = playNext

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ canvas
canvas.width = canvas.offsetWidth
canvas.height = canvas.offsetHeight
</script>
</body>
</html>