<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Neon Audio Player v2</title>

<meta name="theme-color" content="#05080f" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{--bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.25);--text:#e6faff}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;-webkit-tap-highlight-color:transparent}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0a1633,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center;overscroll-behavior:none}

.player{width:360px;max-width:94vw;background:linear-gradient(180deg,rgba(20,40,80,.8),rgba(10,20,40,.95));backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:26px;padding:20px;box-shadow:0 0 60px rgba(0,246,255,.15);border:1px solid rgba(0,246,255,.3)}

.title{text-align:center;color:var(--neon);letter-spacing:3px;font-weight:700;margin-bottom:15px;text-shadow:0 0 10px var(--soft)}

/* –ö–Ω–æ–ø–∫–∞ —Ñ–∞–π–ª–∞ —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è —Ç–∞—á–∞ */
.file-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;padding:16px;border-radius:18px;border:1px dashed var(--neon);color:var(--neon);margin-bottom:15px;cursor:pointer;background:rgba(0,246,255,0.05);transition:0.2s;text-align:center;gap:5px}
.file-btn:active{background:rgba(0,246,255,0.2)}
.file-hint{font-size:11px;opacity:0.7;font-weight:400}
input[type=file]{display:none}

canvas{width:100%;height:60px;border-radius:12px;background:rgba(0,0,0,.3);margin-bottom:10px}

.controls{display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:12px}
.ctrl-btn{width:56px;height:56px;border-radius:50%;border:1px solid var(--neon);background:rgba(0,246,255,.05);display:flex;align-items:center;justify-content:center;transition:.15s;cursor:pointer}
.ctrl-btn.play{width:72px;height:72px}
.ctrl-btn svg{width:26px;height:26px;fill:var(--neon)}
.ctrl-btn:active{transform:scale(.92);box-shadow:0 0 20px var(--neon)}
.ctrl-btn.play.playing{background:rgba(0,246,255,.2);box-shadow:0 0 25px var(--soft)}

.time{display:flex;justify-content:space-between;font-size:12px;opacity:.7;margin-top:6px;font-variant-numeric:tabular-nums}

/* –°—Ç–∏–ª–∏ –ø–æ–ª–∑—É–Ω–∫–æ–≤ (Fixed) */
input[type=range]{
  -webkit-appearance:none;
  width:100%;
  height:6px;
  border-radius:6px;
  outline:none;
  background:rgba(255,255,255,.15); /* –§–æ–Ω –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ */
  margin:0;
  cursor: pointer;
}
/* –í–∞–∂–Ω–æ: —Ç—Ä–µ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç –∏–∑ JS */
input[type=range]::-webkit-slider-runnable-track {
  background: transparent; 
  height: 6px;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;
  width:18px;
  height:18px;
  border-radius:50%;
  background:var(--neon);
  box-shadow:0 0 10px var(--neon);
  margin-top:-6px; /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ */
  position:relative;
  z-index:2;
}

.playlist{margin-top:15px;max-height:180px;overflow-y:auto;font-size:14px;border-top:1px solid rgba(255,255,255,0.1);padding-top:10px}
.track{padding:12px;border-radius:10px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;display:flex;align-items:center;}
.track::before{content:'üéµ';margin-right:8px;font-size:12px;opacity:0.5}
.track.active{background:rgba(0,246,255,.15);color:var(--neon);font-weight:500}
.track.active::before{opacity:1}

.slider-container{
    font-size:12px;
    margin-top:15px;
    display:flex;
    align-items:center;
    gap:10px;
    opacity:.9;
}
</style>
</head>

<body>
<div class="player">
  <div class="title">NEON PLAYER</div>

  <label class="file-btn">
    <div>üìÇ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã</div>
    <div class="file-hint">(–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø–∞–ø–∫–∏ "–§–∞–π–ª—ã")</div>
    <input id="files" type="file" multiple accept="audio/*, .mp3, .m4a, .aac, .wav, .flac" />
  </label>

  <audio id="audio" playsinline webkit-playsinline preload="metadata"></audio>
  <canvas id="viz"></canvas>

  <div class="time">
    <span id="cur">0:00</span>
    <span id="dur">0:00</span>
  </div>
  <div style="padding: 10px 0;">
      <input id="seek" type="range" min="0" value="0" />
  </div>

  <div class="controls">
    <button id="prev" class="ctrl-btn">
      <svg viewBox="0 0 24 24"><polygon points="11,6 5,12 11,18"/><polygon points="19,6 13,12 19,18"/></svg>
    </button>

    <button id="toggle" class="ctrl-btn play">
      <svg id="icon" viewBox="0 0 24 24"><polygon points="8,5 19,12 8,19"/></svg>
    </button>

    <button id="next" class="ctrl-btn">
      <svg viewBox="0 0 24 24"><polygon points="5,6 11,12 5,18"/><polygon points="13,6 19,12 13,18"/></svg>
    </button>
  </div>

  <div class="slider-container">
    <svg style="width:16px;height:16px;fill:var(--neon)" viewBox="0 0 24 24"><path d="M3,9v6h4l5,5V4L7,9H3z M16.5,12c0-1.77-1.02-3.29-2.5-4.03v8.05C15.48,15.29,16.5,13.77,16.5,12z"/></svg>
    <input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
  </div>

  <div id="playlist" class="playlist">
      <div style="text-align:center; opacity:0.5; padding:20px; font-size:12px;">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç</div>
  </div>
</div>

<script>
const audio = document.getElementById('audio')
const filesEl = document.getElementById('files')
const playlistEl = document.getElementById('playlist')
const seek = document.getElementById('seek')
const volume = document.getElementById('volume')
const cur = document.getElementById('cur')
const dur = document.getElementById('dur')
const toggle = document.getElementById('toggle')
const icon = document.getElementById('icon')
const canvas = document.getElementById('viz')
const ctx = canvas.getContext('2d')

let playlist = []
let current = 0
let audioCtx, analyser, source
let isVizInit = false

/* –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –ø–æ–ª–∑—É–Ω–∫–æ–≤ (–ì—Ä–∞–¥–∏–µ–Ω—Ç) */
function updateRangeBackground(rangeInput) {
  const min = rangeInput.min || 0
  const max = rangeInput.max || 100
  const val = rangeInput.value
  const percentage = (val - min) * 100 / (max - min)
  rangeInput.style.background = `linear-gradient(90deg, var(--neon) ${percentage}%, rgba(255,255,255,0.15) ${percentage}%)`
}

/* –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ */
const fmt = t => {
  if (!t || isNaN(t)) return '0:00'
  const m = Math.floor(t / 60)
  const s = Math.floor(t % 60)
  return `${m}:${s < 10 ? '0' + s : s}`
}

/* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä */
function initAudioContext() {
  if (isVizInit) return
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext
    audioCtx = new AudioContext()
    analyser = audioCtx.createAnalyser()
    source = audioCtx.createMediaElementSource(audio)
    source.connect(analyser)
    analyser.connect(audioCtx.destination)
    analyser.fftSize = 64
    isVizInit = true
    drawViz()
  } catch (e) { console.log("Audio API Error (iOS restriction or similar)") }
}

function drawViz() {
  if (!isVizInit) return
  requestAnimationFrame(drawViz)
  if(audio.paused) return 

  const bufferLength = analyser.frequencyBinCount
  const dataArray = new Uint8Array(bufferLength)
  analyser.getByteFrequencyData(dataArray)

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.fillStyle = '#00f6ff'
  
  const barWidth = (canvas.width / bufferLength) * 2.5
  let x = 0
  for (let i = 0; i < bufferLength; i++) {
    const barHeight = (dataArray[i] / 255) * canvas.height
    // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
    ctx.globalAlpha = 0.3 + (dataArray[i] / 255) * 0.7
    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight)
    x += barWidth + 2
  }
}

/* iOS Lock Screen Integration */
function updateMediaSession() {
  if (!('mediaSession' in navigator) || !playlist[current]) return
  const track = playlist[current]
  navigator.mediaSession.metadata = new MediaMetadata({
    title: track.name.replace(/\.[^/.]+$/, ""),
    artist: 'Neon Player',
    artwork: [{ src: 'https://via.placeholder.com/512/05080f/00f6ff?text=AUDIO', sizes: '512x512', type: 'image/png' }]
  })
  navigator.mediaSession.setActionHandler('play', () => togglePlay(true))
  navigator.mediaSession.setActionHandler('pause', () => togglePlay(false))
  navigator.mediaSession.setActionHandler('previoustrack', playPrev)
  navigator.mediaSession.setActionHandler('nexttrack', playNext)
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
function loadIndex(i) {
  if (i < 0 || i >= playlist.length) return
  current = i
  document.querySelectorAll('.track').forEach((el, n) => el.classList.toggle('active', n === i))
  
  audio.src = playlist[i].url
  audio.load()
  updateMediaSession()
  
  // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  seek.value = 0
  updateRangeBackground(seek)
}

async function togglePlay(forceState) {
  if (!isVizInit) initAudioContext()
  if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume()

  try {
    const shouldPlay = forceState !== undefined ? forceState : audio.paused
    if (shouldPlay) await audio.play()
    else audio.pause()
  } catch (err) { console.error(err) }
}

function playNext() { loadIndex((current + 1) % playlist.length); togglePlay(true) }
function playPrev() { loadIndex((current - 1 + playlist.length) % playlist.length); togglePlay(true) }

/* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ */
filesEl.onchange = () => {
  const newFiles = [...filesEl.files].map(f => ({ name: f.name, url: URL.createObjectURL(f) }))
  if (!newFiles.length) return

  const wasEmpty = playlist.length === 0
  playlist = [...playlist, ...newFiles]
  
  playlistEl.innerHTML = ''
  playlist.forEach((t, i) => {
    const d = document.createElement('div')
    d.className = 'track' + (i === current && !wasEmpty ? ' active' : '')
    d.textContent = t.name
    d.onclick = () => { loadIndex(i); togglePlay(true) }
    playlistEl.appendChild(d)
  })
  
  if (wasEmpty) loadIndex(0)
}

/* UI Events */
toggle.onclick = () => togglePlay()
document.getElementById('next').onclick = playNext
document.getElementById('prev').onclick = playPrev

volume.oninput = () => {
  audio.volume = volume.value
  updateRangeBackground(volume)
}

audio.ontimeupdate = () => {
    if(!audio.duration) return
    seek.max = audio.duration
    seek.value = audio.currentTime
    updateRangeBackground(seek)
    cur.textContent = fmt(audio.currentTime)
    dur.textContent = fmt(audio.duration)
}

seek.oninput = () => {
    audio.currentTime = seek.value
    updateRangeBackground(seek)
}

audio.onplay = () => {
  icon.innerHTML = '<rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/>'
  toggle.classList.add('playing')
  if('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing"
}

audio.onpause = () => {
  icon.innerHTML = '<polygon points="8,5 19,12 8,19"/>'
  toggle.classList.remove('playing')
  if('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused"
}

audio.onended = playNext

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ canvas –∏ —Ü–≤–µ—Ç–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
canvas.width = canvas.offsetWidth
canvas.height = canvas.offsetHeight
updateRangeBackground(volume) // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ —Å—Ä–∞–∑—É
</script>
</body>
</html>