<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neon Audio Player (Single File)</title>
<meta name="theme-color" content="#00f6ff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<style>
:root{--bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.3);--text:#e6faff}
*{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#081020,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center}
.player{width:360px;background:rgba(10,20,40,.65);border-radius:22px;padding:16px;box-shadow:0 0 40px var(--soft);border:1px solid var(--soft)}
.title{text-align:center;color:var(--neon);letter-spacing:2px;margin-bottom:8px}
input[type=file]{width:100%;margin-bottom:8px}
canvas{width:100%;height:60px;margin-top:6px}
.controls{display:flex;gap:6px;margin-top:8px}
button{flex:1;height:42px;background:transparent;border:1px solid var(--neon);color:var(--neon);border-radius:14px;cursor:pointer;position:relative;overflow:hidden;transition:transform .15s,box-shadow .15s}
button:active{transform:scale(.95);box-shadow:0 0 20px var(--neon)}
button.playing{animation:pulse 1.2s infinite}
@keyframes pulse{0%{box-shadow:0 0 6px var(--soft)}50%{box-shadow:0 0 22px var(--neon)}100%{box-shadow:0 0 6px var(--soft)}}
.time{display:flex;justify-content:space-between;font-size:11px;opacity:.8;margin-top:4px}
.playlist{margin-top:8px;max-height:120px;overflow-y:auto;font-size:13px}
.track{padding:8px;border-radius:10px;cursor:pointer;transition:background .15s,box-shadow .15s,transform .15s}
.track.active{background:var(--soft);color:var(--neon);box-shadow:0 0 12px var(--soft)}
.track.active.beat{box-shadow:0 0 24px var(--neon);background:rgba(0,246,255,.25);transform:scale(1.03)}
.slider{font-size:12px;margin-top:6px}
.status{font-size:11px;opacity:.7;margin-top:4px;text-align:center}
</style>
</head>
<body>
<div class="player">
<div class="title">NEON AUDIO PLAYER</div>
<input id="files" type="file" multiple accept="audio/*,video/mp4" />
<audio id="audio" playsinline></audio>
<canvas id="viz"></canvas>
<div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
<input id="seek" type="range" min="0" value="0" />
<div class="controls">
<button id="prev">⏮</button>
<button id="play">▶</button>
<button id="pause">⏸</button>
<button id="next">⏭</button>
</div>
<div class="slider">Громкость
<input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
</div>
<div id="playlist" class="playlist"></div>
<div id="status" class="status"></div>
</div>
<script>
const files=document.getElementById('files')
const audio=document.getElementById('audio')
const playlistEl=document.getElementById('playlist')
const canvas=document.getElementById('viz')
const ctx=canvas.getContext('2d')
const seek=document.getElementById('seek')
const cur=document.getElementById('cur')
const dur=document.getElementById('dur')
const volume=document.getElementById('volume')
const statusEl=document.getElementById('status')
const playBtn=document.getElementById('play')

let playlist=[]
let current=-1
let ac, analyser

function fmt(t){if(!t)return'0:00';const m=Math.floor(t/60),s=Math.floor(t%60);return m+':' + (s<10?'0':'')+s}

function setupAudio(){
 if(ac) return
 ac=new AudioContext()
 analyser=ac.createAnalyser()
 const src=ac.createMediaElementSource(audio)
 src.connect(analyser)
 analyser.connect(ac.destination)
}

async function mp4ToAudio(file){
 statusEl.textContent='Конвертация mp4 → audio…'
 return new Promise(res=>{
  const v=document.createElement('video')
  v.src=URL.createObjectURL(file)
  v.muted=true
  v.onloadeddata=()=>{
   const c=new AudioContext()
   const s=c.createMediaElementSource(v)
   const d=c.createMediaStreamDestination()
   s.connect(d)
   const r=new MediaRecorder(d.stream)
   const ch=[]
   r.ondataavailable=e=>ch.push(e.data)
   r.onstop=()=>res(new File(ch,file.name.replace(/\.mp4$/,'.m4a'),{type:'audio/mp4'}))
   v.play();r.start();v.onended=()=>r.stop()
  }
 })
}

async function loadTrack(i){
 const f=playlist[i]; if(!f) return
 document.querySelectorAll('.track').forEach((t,n)=>t.classList.toggle('active',n===i))
 let file=f.type==='video/mp4'?await mp4ToAudio(f):f
 audio.src=URL.createObjectURL(file)
 setupAudio()
 audio.play()
 playBtn.classList.add('playing')
 current=i
 if('mediaSession'in navigator){navigator.mediaSession.metadata=new MediaMetadata({title:file.name})}
 statusEl.textContent=''
}

files.onchange=()=>{
 playlist=[...files.files]
 playlistEl.innerHTML=''
 playlist.forEach((f,i)=>{
  const d=document.createElement('div')
  d.className='track'
  d.textContent=f.name
  d.onclick=()=>loadTrack(i)
  playlistEl.appendChild(d)
 })
}

playBtn.onclick=()=>audio.play()
document.getElementById('pause').onclick=()=>audio.pause()
document.getElementById('next').onclick=()=>playlist.length&&loadTrack((current+1)%playlist.length)
document.getElementById('prev').onclick=()=>playlist.length&&loadTrack((current-1+playlist.length)%playlist.length)

volume.oninput=()=>audio.volume=volume.value
seek.oninput=()=>audio.currentTime=seek.value

audio.ontimeupdate=()=>{
 seek.max=audio.duration||0
 seek.value=audio.currentTime||0
 cur.textContent=fmt(audio.currentTime)
 dur.textContent=fmt(audio.duration)
}

audio.onended=()=>document.getElementById('next').click()

audio.onplay=()=>playBtn.classList.add('playing')
audio.onpause=()=>playBtn.classList.remove('playing')

function draw(){
 if(!analyser){requestAnimationFrame(draw);return}
 const w=canvas.width=canvas.offsetWidth
 const h=canvas.height=canvas.offsetHeight
 const data=new Uint8Array(analyser.frequencyBinCount)
 analyser.getByteFrequencyData(data)
 ctx.clearRect(0,0,w,h)
 let bass=0
 for(let i=0;i<12;i++) bass+=data[i]
 bass/=12
 data.forEach((v,i)=>{
  const bw=w/data.length
  ctx.fillStyle='rgba(0,246,255,.8)'
  ctx.fillRect(i*bw,h,h-(v/255*h),bw-1)
 })
 document.querySelectorAll('.track').forEach((t,i)=>{
  if(i===current) t.classList.toggle('beat',bass>140)
 })
 requestAnimationFrame(draw)
}
draw()
</script>
</body>
</html>
