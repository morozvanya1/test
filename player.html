<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neon Audio Player (iOS PWA Safe)</title>
<meta name="theme-color" content="#00f6ff" />
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwH" />

<!-- iOS PWA meta -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<style>
:root{--bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.3);--text:#e6faff}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#081020,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center}
.player{width:350px;background:rgba(10,20,40,.6);border-radius:20px;padding:16px;box-shadow:0 0 40px var(--soft);border:1px solid var(--soft)}
.title{text-align:center;color:var(--neon);letter-spacing:2px;margin-bottom:8px}
input[type=file]{width:100%;margin-bottom:8px}
audio{width:100%;display:block;border-radius:12px;margin-top:6px}
canvas{width:100%;height:60px;margin-top:6px}
.controls{display:flex;gap:6px;margin-top:8px}
button{flex:1;height:40px;background:transparent;border:1px solid var(--neon);color:var(--neon);border-radius:12px}
.slider{margin-top:6px;font-size:12px}
.time{display:flex;justify-content:space-between;font-size:11px;opacity:.8}
.playlist{margin-top:8px;max-height:110px;overflow-y:auto;font-size:13px}
.track{padding:6px;border-radius:6px;cursor:pointer}
.track.active{background:var(--soft);color:var(--neon)}
.status{font-size:11px;opacity:.7;margin-top:4px;text-align:center}
</style>
</head>
<body>
<div class="player">
<div class="title">NEON AUDIO PLAYER</div>
<input id="files" type="file" multiple accept="audio/*,video/mp4,.mp3,.m4a" />
<audio id="audio" controls playsinline></audio>
<canvas id="viz"></canvas>
<div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
<input id="seek" type="range" min="0" value="0" />
<div class="controls">
<button id="prev">⏮</button><button id="play">▶</button><button id="pause">⏸</button><button id="next">⏭</button>
</div>
<div class="slider">Громкость
<input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
</div>
<div id="playlist" class="playlist"></div>
<div id="status" class="status"></div>
</div>

<script>
/* ================= IMPORTANT =================
 Service Workers CANNOT be registered from blob: URLs.
 For a true offline-capable PWA, sw.js MUST be a real file.
 This single-file version is iOS-safe and WILL play audio
 on the lock screen when added to Home Screen.
============================================= */

/* ===== PLAYER LOGIC ===== */
const filesInput=document.getElementById('files')
const audio=document.getElementById('audio')
const playlistEl=document.getElementById('playlist')
const volume=document.getElementById('volume')
const seek=document.getElementById('seek')
const cur=document.getElementById('cur')
const dur=document.getElementById('dur')
const canvas=document.getElementById('viz')
const statusEl=document.getElementById('status')
const ctx=canvas.getContext('2d')

let playlist=[],current=-1,ac=null,analyser=null,db=null

/* ===== IndexedDB Cache ===== */
const openDB=()=>new Promise(r=>{
 const o=indexedDB.open('neon-db',1)
 o.onupgradeneeded=()=>o.result.createObjectStore('tracks')
 o.onsuccess=()=>r(o.result)
})

const getCached=k=>new Promise(r=>{
 const t=db.transaction('tracks','readonly').objectStore('tracks').get(k)
 t.onsuccess=()=>r(t.result)
})

const setCached=(k,v)=>db.transaction('tracks','readwrite').objectStore('tracks').put(v,k)

/* ===== Audio Context ===== */
function setupCtx(){
 if(ac) return
 ac=new AudioContext()
 analyser=ac.createAnalyser()
 const src=ac.createMediaElementSource(audio)
 src.connect(analyser)
 analyser.connect(ac.destination)
}

function fmt(t){
 if(!t)return'0:00'
 const m=Math.floor(t/60)
 const s=Math.floor(t%60)
 return m+':'+(s<10?'0':'')+s
}

/* ===== mp4 → audio ===== */
async function mp4ToAudio(file){
 statusEl.textContent='Конвертация mp4 → audio…'
 return new Promise(res=>{
  const v=document.createElement('video')
  v.src=URL.createObjectURL(file)
  v.muted=true
  v.playsInline=true
  v.onloadeddata=()=>{
   const c=new AudioContext()
   const s=c.createMediaElementSource(v)
   const d=c.createMediaStreamDestination()
   s.connect(d)
   const r=new MediaRecorder(d.stream,{mimeType:'audio/mp4'})
   const ch=[]
   r.ondataavailable=e=>ch.push(e.data)
   r.onstop=()=>res(new File(ch,file.name.replace(/\.mp4$/,'.m4a'),{type:'audio/mp4'}))
   v.play();r.start();v.onended=()=>r.stop()
  }
 })
}

/* ===== Playback ===== */
async function loadTrack(i){
 const f=playlist[i]; if(!f) return
 document.querySelectorAll('.track').forEach((t,n)=>t.classList.toggle('active',n===i))
 let file=await getCached(f.name)
 if(!file){
  file=f.type==='video/mp4'?await mp4ToAudio(f):f
  setCached(f.name,file)
 }
 statusEl.textContent=''
 audio.src=URL.createObjectURL(file)
 setupCtx()
 audio.play()
 current=i
 if('mediaSession' in navigator){
  navigator.mediaSession.metadata=new MediaMetadata({title:file.name,artist:'Neon Player'})
 }
}

filesInput.onchange=async()=>{
 db=await openDB()
 playlist=[...filesInput.files]
 playlistEl.innerHTML=''
 playlist.forEach((f,i)=>{
  const d=document.createElement('div')
  d.className='track'
  d.textContent=f.name
  d.onclick=()=>loadTrack(i)
  playlistEl.appendChild(d)
 })
}

play.onclick=()=>audio.play()
pause.onclick=()=>audio.pause()
next.onclick=()=>playlist.length&&loadTrack((current+1)%playlist.length)
prev.onclick=()=>playlist.length&&loadTrack((current-1+playlist.length)%playlist.length)
volume.oninput=()=>audio.volume=volume.value
seek.oninput=()=>audio.currentTime=seek.value

audio.ontimeupdate=()=>{
 seek.max=audio.duration||0
 seek.value=audio.currentTime||0
 cur.textContent=fmt(audio.currentTime)
 dur.textContent=fmt(audio.duration)
}

audio.onended=()=>next.click()

/* ===== Visualizer ===== */
function draw(){
 if(!analyser){requestAnimationFrame(draw);return}
 const w=canvas.width=canvas.offsetWidth
 const h=canvas.height=canvas.offsetHeight
 const data=new Uint8Array(analyser.frequencyBinCount)
 analyser.getByteFrequencyData(data)
 ctx.clearRect(0,0,w,h)
 data.forEach((v,i)=>{
  const bw=w/data.length
  ctx.fillStyle='rgba(0,246,255,.8)'
  ctx.fillRect(i*bw,h,h-(v/255*h),bw-1)
 })
 requestAnimationFrame(draw)
}
draw()
</script>
</body>
</html>
