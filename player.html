<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neon Audio Player</title>
<style>
:root{--bg:#05080f;--neon:#00f6ff;--soft:rgba(0,246,255,.3);--text:#e6faff}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#081020,var(--bg));color:var(--text);display:flex;align-items:center;justify-content:center}
.player{width:350px;background:rgba(10,20,40,.6);border-radius:20px;padding:16px;box-shadow:0 0 40px var(--soft);border:1px solid var(--soft)}
.title{text-align:center;color:var(--neon);letter-spacing:2px;margin-bottom:8px}
input[type=file]{width:100%;margin-bottom:8px}
audio{width:100%;display:block;border-radius:12px;margin-top:6px}
canvas{width:100%;height:60px;margin-top:6px}
.controls{display:flex;gap:6px;margin-top:8px}
button{flex:1;height:40px;background:transparent;border:1px solid var(--neon);color:var(--neon);border-radius:12px}
.slider{margin-top:6px;font-size:12px}
.time{display:flex;justify-content:space-between;font-size:11px;opacity:.8}
.playlist{margin-top:8px;max-height:110px;overflow-y:auto;font-size:13px}
.track{padding:6px;border-radius:6px;cursor:pointer}
.track.active{background:var(--soft);color:var(--neon)}
.status{font-size:11px;opacity:.7;margin-top:4px;text-align:center}
</style>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#00f6ff" />
</head>
<body>
<div class="player">
<div class="title">NEON AUDIO PLAYER</div>
<input id="files" type="file" multiple accept="audio/*,video/mp4,.mp3,.m4a" />
<audio id="audio" controls playsinline></audio>
<canvas id="viz"></canvas>
<div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
<input id="seek" type="range" min="0" value="0" />
<div class="controls">
<button id="prev">⏮</button><button id="play">▶</button><button id="pause">⏸</button><button id="next">⏭</button>
</div>
<div class="slider">Громкость
<input id="volume" type="range" min="0" max="1" step="0.01" value="1" />
</div>
<div id="playlist" class="playlist"></div>
<div id="status" class="status"></div>
</div>
<script>
const filesInput=document.getElementById('files')
const audio=document.getElementById('audio')
const playlistEl=document.getElementById('playlist')
const volume=document.getElementById('volume')
const seek=document.getElementById('seek')
const cur=document.getElementById('cur')
const dur=document.getElementById('dur')
const canvas=document.getElementById('viz')
const statusEl=document.getElementById('status')
const ctx=canvas.getContext('2d')

let playlist=[],current=-1,ac=null,analyser=null,source=null
let db=null

/* ================= CACHE (IndexedDB) ================= */
const openDB=()=>new Promise(res=>{
 const r=indexedDB.open('neon-player',1)
 r.onupgradeneeded=()=>r.result.createObjectStore('tracks')
 r.onsuccess=()=>res(r.result)
})

const getCached=key=>new Promise(res=>{
 const tx=db.transaction('tracks','readonly').objectStore('tracks').get(key)
 tx.onsuccess=()=>res(tx.result)
})

const setCached=(key,val)=>{
 const tx=db.transaction('tracks','readwrite').objectStore('tracks').put(val,key)
}

/* ================= AUDIO ================= */
function fmt(t){if(!t)return'0:00';const m=Math.floor(t/60),s=Math.floor(t%60);return m+':'+(s<10?'0':'')+s}

function setupCtx(){
 if(ac) return
 ac=new AudioContext()
 analyser=ac.createAnalyser()
 analyser.fftSize=64
 source=ac.createMediaElementSource(audio)
 source.connect(analyser)
 analyser.connect(ac.destination)
}

async function mp4ToAudio(file){
 statusEl.textContent='Конвертация mp4 → audio…'
 return new Promise(resolve=>{
  const v=document.createElement('video')
  v.src=URL.createObjectURL(file)
  v.muted=true
  v.playsInline=true
  v.onloadeddata=()=>{
   const ctx=new AudioContext()
   const src=ctx.createMediaElementSource(v)
   const dest=ctx.createMediaStreamDestination()
   src.connect(dest)
   const rec=new MediaRecorder(dest.stream,{mimeType:'audio/mp4'})
   const chunks=[]
   rec.ondataavailable=e=>chunks.push(e.data)
   rec.onstop=()=>resolve(new File(chunks,file.name.replace(/\.mp4$/,'.m4a'),{type:'audio/mp4'}))
   v.play();rec.start();v.onended=()=>rec.stop()
  }
 })
}

async function loadTrack(i){
 const f=playlist[i];if(!f)return
 document.querySelectorAll('.track').forEach((t,n)=>t.classList.toggle('active',n===i))
 let file=await getCached(f.name)
 if(!file){
  file=f.type==='video/mp4'?await mp4ToAudio(f):f
  setCached(f.name,file)
 }
 statusEl.textContent=''
 audio.src=URL.createObjectURL(file)
 audio.volume=volume.value
 setupCtx();audio.play();current=i
}

/* ================= UI ================= */
filesInput.onchange=async()=>{
 db=await openDB()
 playlist=[...filesInput.files]
 playlistEl.innerHTML=''
 playlist.forEach((f,i)=>{
  const d=document.createElement('div')
  d.className='track'
  d.textContent=f.name
  d.onclick=()=>loadTrack(i)
  playlistEl.appendChild(d)
 })
}

play.onclick=()=>audio.play()
pause.onclick=()=>audio.pause()
next.onclick=()=>playlist.length&&loadTrack((current+1)%playlist.length)
prev.onclick=()=>playlist.length&&loadTrack((current-1+playlist.length)%playlist.length)
volume.oninput=()=>audio.volume=volume.value
seek.oninput=()=>audio.currentTime=seek.value

audio.ontimeupdate=()=>{
 seek.max=audio.duration||0
 seek.value=audio.currentTime||0
 cur.textContent=fmt(audio.currentTime)
 dur.textContent=fmt(audio.duration)
}

audio.onended=()=>next.click()

/* ================= VISUAL ================= */
function draw(){
 if(!analyser){requestAnimationFrame(draw);return}
 const w=canvas.width=canvas.offsetWidth
 const h=canvas.height=canvas.offsetHeight
 const data=new Uint8Array(analyser.frequencyBinCount)
 analyser.getByteFrequencyData(data)
 ctx.clearRect(0,0,w,h)
 data.forEach((v,i)=>{
  const bw=w/data.length
  ctx.fillStyle='rgba(0,246,255,.8)'
  ctx.fillRect(i*bw,h,h-(v/255*h),bw-1)
 })
 requestAnimationFrame(draw)
}
draw()

/* ================= LOCK SCREEN SUPPORT ================= */
document.addEventListener('visibilitychange',()=>{
 if(document.hidden && !audio.paused){ audio.play() }
})
</script>
<script>
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js')
}
</script>
</body>
</html>
