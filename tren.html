<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Fitness Pro</title>
  <style>
    :root {
      --bg-color: #000000; /* Deep OLED Black */
      --card-bg: #1c1c1e; /* iOS Dark Gray */
      --primary: #0A84FF; /* iOS Blue Dark Mode */
      --danger: #FF453A; /* iOS Red Dark Mode */
      --text: #FFFFFF;
      --text-secondary: #8E8E93;
      --separator: #38383A;
      --radius: 14px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; 
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: var(--bg-color); 
      color: var(--text);
      /* Учет безопасных зон iPhone */
      padding-top: var(--safe-top);
      padding-bottom: calc(80px + var(--safe-bottom)); 
      -webkit-font-smoothing: antialiased;
    }

    /* Стеклянный заголовок (Glassmorphism) */
    .header-sticky {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-bottom: 0.5px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 { font-size: 22px; font-weight: 700; margin: 0; letter-spacing: -0.5px; }

    .container { 
      padding: 20px; 
      max-width: 500px; 
      margin: 0 auto; 
    }

    h3 { 
      color: var(--text-secondary); 
      font-size: 13px; 
      text-transform: uppercase; 
      margin: 24px 0 8px 16px; 
      letter-spacing: 0.5px;
    }

    /* iOS Grouped List Style */
    .card { 
      background: var(--card-bg); 
      border-radius: var(--radius); 
      overflow: hidden;
      margin-bottom: 24px;
    }

    /* Inputs & Selects styled like iOS List Items */
    .input-group {
      display: flex;
      flex-direction: column;
    }
    
    .input-row {
      display: flex;
      align-items: center;
      padding: 0 16px;
      height: 50px; /* Стандартная высота строки iOS */
      border-bottom: 0.5px solid var(--separator);
      background: var(--card-bg);
    }
    .input-row:last-child { border-bottom: none; }

    select, input {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 17px; /* 17px предотвращает зум на iOS */
      font-family: inherit;
      padding: 10px 0;
    }
    
    input::placeholder { color: var(--text-secondary); }
    
    /* Buttons */
    button {
      background: var(--primary);
      color: white;
      border: none;
      font-size: 17px;
      font-weight: 600;
      padding: 14px;
      border-radius: var(--radius);
      width: 100%;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }
    button:active { transform: scale(0.97); opacity: 0.8; }
    
    button.secondary {
      background: rgba(118, 118, 128, 0.24);
      color: var(--primary);
    }
    
    button.icon-only {
      background: transparent;
      width: auto;
      padding: 8px;
    }

    /* Sets Layout */
    .set-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 0.5px solid var(--separator);
      animation: slideIn 0.3s ease;
    }
    .set-index { 
      width: 24px; 
      color: var(--text-secondary); 
      font-size: 15px; 
      font-variant-numeric: tabular-nums;
    }
    .set-inputs { display: flex; gap: 12px; flex: 1; }
    .set-inputs input {
      background: rgba(118, 118, 128, 0.24);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      height: 36px;
    }
    .btn-delete {
      width: 24px; height: 24px;
      background: var(--danger);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin-left: 10px;
      padding: 0;
    }
    .btn-delete svg { width: 14px; height: 14px; fill: white; }

    /* History List */
    .history-group { margin-bottom: 20px; }
    .history-date { 
      font-size: 20px; font-weight: 700; 
      margin: 0 0 10px 4px; 
      color: var(--text);
    }
    .history-item {
      background: var(--card-bg);
      padding: 16px;
      margin-bottom: 1px; /* Тонкий разделитель */
    }
    .history-item:first-child { border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }
    .history-item:last-child { border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); }

    .history-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .tags-container { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag {
      font-size: 13px;
      background: rgba(10, 132, 255, 0.15);
      color: var(--primary);
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }

    /* Floating Action Button (Optional for large screens) */
    .fab-container {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: 20px; right: 20px;
      max-width: 500px; margin: 0 auto;
      z-index: 90;
      display: flex; gap: 10px;
    }

    /* Modal iOS Style */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      z-index: 200;
      display: none;
      align-items: flex-end; /* Sheet style from bottom */
    }
    .modal.active { display: flex; }
    .modal-card {
      background: #1c1c1e;
      width: 100%;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 80vh;
      display: flex; flex-direction: column;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .modal-handle {
      width: 40px; height: 5px; background: #38383A;
      border-radius: 100px; margin: -10px auto 20px auto;
    }

    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="header-sticky">
  <h1>FitTrack Pro</h1>
  <div style="display:flex; gap: 10px;">
    <button class="icon-only" onclick="openExerciseManager()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0A84FF" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"></path>
      </svg>
    </button>
    <button class="icon-only" id="lockBtn" onclick="toggleEditMode()">
      <svg id="lockIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0A84FF" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    </button>
  </div>
</div>

<div class="container">
  
  <h3>Тренировка</h3>
  <div class="card">
    <div class="input-row">
      <select id="exerciseSelect" onchange="loadLastSessionHint()"></select>
    </div>
    <div class="input-row" id="lastSessionHint" style="display:none; height:30px; font-size:13px; color:var(--text-secondary);">
      <span id="hintText"></span>
    </div>
  </div>

  <h3>Подходы</h3>
  <div class="card" id="setsContainer" style="min-height: 50px;">
    </div>
  
  <button class="secondary" onclick="addSet()" style="margin-bottom: 20px;">+ Добавить подход</button>

  <h3>История</h3>
  <div class="card" style="padding:0; background: transparent;">
     <div style="padding: 0 16px 10px;">
        <select id="filterExercise" onchange="renderHistory()" style="background: var(--card-bg); padding: 8px 16px; border-radius: 10px;">
           <option value="">Все упражнения</option>
        </select>
     </div>
     <div id="historyList"></div>
  </div>

  <br><br><br> </div>

<div class="fab-container">
  <button onclick="saveWorkout()" style="box-shadow: 0 4px 15px rgba(0,0,0,0.5);">Сохранить тренировку</button>
</div>

<div class="modal" id="exerciseModal">
  <div class="modal-card">
    <div class="modal-handle" onclick="closeExerciseManager()"></div>
    <div class="modal-header">
      <h2 style="margin:0; font-size:20px;">Упражнения</h2>
      <button class="secondary" style="width:auto; padding: 6px 12px; font-size:15px;" onclick="closeExerciseManager()">Готово</button>
    </div>
    <div style="overflow-y:auto; flex:1; margin-bottom:15px;" id="exerciseManagerList"></div>
    <div style="display:flex; gap:10px;">
      <input id="newExerciseInput" placeholder="Новое упражнение" style="background: rgba(118,118,128,0.24); border-radius:10px; padding-left:12px;">
      <button onclick="addExercise()" style="width:auto;">➕</button>
    </div>
  </div>
</div>

<script>
// --- JS Logic (Same as before, simplified for this view) ---
const STORAGE_KEY = 'fitness_data_v3';
const EXERCISE_KEY = 'fitness_exercises_v3';
let appData = [], exercises = [], currentSets = [], editMode = false, editingId = null;

window.onload = () => { loadData(); renderExercises(); renderHistory(); addSet(); };

function loadData() {
  appData = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  exercises = JSON.parse(localStorage.getItem(EXERCISE_KEY) || '[]');
  if (!exercises.length) { exercises = ['Жим лежа', 'Приседания', 'Становая тяга', 'Жим стоя', 'Тяга блока']; saveExercises(); }
}
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
function saveExercises() { localStorage.setItem(EXERCISE_KEY, JSON.stringify(exercises)); }

function addSet() {
  const lastSet = currentSets.length > 0 ? currentSets[currentSets.length - 1] : { reps: '', weight: '' };
  currentSets.push({ id: Date.now(), reps: lastSet.reps, weight: lastSet.weight });
  renderSets();
}
function removeSet(idx) {
  if (currentSets.length > 1) currentSets.splice(idx, 1);
  else currentSets[0] = { reps: '', weight: '' };
  renderSets();
}
function updateSet(idx, f, v) { currentSets[idx][f] = v; }

function renderSets() {
  const c = document.getElementById('setsContainer'); c.innerHTML = '';
  currentSets.forEach((s, i) => {
    const r = document.createElement('div'); r.className = 'set-row';
    r.innerHTML = `
      <span class="set-index">${i + 1}</span>
      <div class="set-inputs">
        <input type="number" placeholder="кг" value="${s.weight}" oninput="updateSet(${i},'weight',this.value)">
        <input type="number" placeholder="повт" value="${s.reps}" oninput="updateSet(${i},'reps',this.value)">
      </div>
      <button class="btn-delete" onclick="removeSet(${i})"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
    `;
    c.appendChild(r);
  });
}

function saveWorkout() {
  const name = document.getElementById('exerciseSelect').value;
  const validSets = currentSets.filter(s => s.reps && s.weight);
  if (!validSets.length) return alert('Заполните подходы');
  
  // Haptic feedback simulation
  if(navigator.vibrate) navigator.vibrate(50);

  const rec = { id: editingId || crypto.randomUUID(), name, sets: validSets, date: editingId ? appData.find(x=>x.id===editingId).date : Date.now() };
  
  if (editingId) {
    appData[appData.findIndex(x=>x.id===editingId)] = rec;
    editingId = null;
    document.querySelector('.fab-container button').textContent = 'Сохранить тренировку';
  } else appData.push(rec);

  saveData(); currentSets=[]; addSet(); renderHistory();
  window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
}

function renderHistory() {
  const c = document.getElementById('historyList'); c.innerHTML = '';
  const filter = document.getElementById('filterExercise').value;
  const sorted = [...appData].sort((a,b) => b.date - a.date);
  const groups = {};
  
  sorted.forEach(i => {
    if(filter && i.name !== filter) return;
    const d = new Date(i.date).toLocaleDateString('ru-RU', { weekday:'short', day:'numeric', month:'long' });
    if(!groups[d]) groups[d] = []; groups[d].push(i);
  });

  Object.keys(groups).forEach(date => {
    const grp = document.createElement('div'); grp.className = 'history-group';
    grp.innerHTML = `<div class="history-date">${date}</div>`;
    groups[date].forEach(w => {
      const item = document.createElement('div'); item.className = 'history-item';
      const setsHtml = w.sets.map(s => `<span class="tag">${s.weight}×${s.reps}</span>`).join('');
      const actions = editMode ? `<div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end;"><button class="secondary" style="width:auto; padding:6px 12px; font-size:13px;" onclick="editRec('${w.id}')">Изм</button><button class="secondary" style="width:auto; padding:6px 12px; font-size:13px; color:var(--danger);" onclick="delRec('${w.id}')">Удл</button></div>` : '';
      item.innerHTML = `<div class="history-header"><b>${w.name}</b></div><div class="tags-container">${setsHtml}</div>${actions}`;
      grp.appendChild(item);
    });
    c.appendChild(grp);
  });
}

function editRec(id) {
  const r = appData.find(x => x.id === id);
  if(!r) return;
  document.getElementById('exerciseSelect').value = r.name;
  currentSets = JSON.parse(JSON.stringify(r.sets));
  editingId = id;
  document.querySelector('.fab-container button').textContent = 'Обновить запись';
  renderSets();
  window.scrollTo({top:0, behavior:'smooth'});
}
function delRec(id) { if(confirm('Удалить?')) { appData=appData.filter(x=>x.id!==id); saveData(); renderHistory(); } }

function toggleEditMode() {
  editMode = !editMode;
  document.getElementById('lockBtn').style.opacity = editMode ? '1' : '0.5';
  renderHistory();
}

function loadLastSessionHint() {
  const name = document.getElementById('exerciseSelect').value;
  const last = appData.filter(x => x.name === name).sort((a,b) => b.date - a.date)[0];
  const hint = document.getElementById('lastSessionHint');
  if(last) {
    const best = last.sets.reduce((p,c) => (p.weight*1 > c.weight*1) ? p : c);
    document.getElementById('hintText').textContent = `Прошлый раз: ${best.weight}кг × ${best.reps}`;
    hint.style.display = 'flex';
  } else hint.style.display = 'none';
}

// Exercise Manager UI
function renderExercises() {
  const s = document.getElementById('exerciseSelect');
  const f = document.getElementById('filterExercise');
  const oldVal = s.value; const oldF = f.value;
  s.innerHTML = '<option disabled selected>Выбрать...</option>';
  f.innerHTML = '<option value="">Все упражнения</option>';
  exercises.forEach(e => {
    s.add(new Option(e,e)); f.add(new Option(e,e));
  });
  if(exercises.includes(oldVal)) s.value = oldVal;
  f.value = oldF;
}
function openExerciseManager() {
  const l = document.getElementById('exerciseManagerList'); l.innerHTML = '';
  exercises.forEach((e,i) => {
    const d = document.createElement('div'); d.style.padding='10px'; d.style.borderBottom='1px solid #333'; d.style.display='flex'; d.style.justifyContent='space-between';
    d.innerHTML = `<span>${e}</span><span onclick="removeExercise(${i})" style="color:red; cursor:pointer;">⛔</span>`;
    l.appendChild(d);
  });
  document.getElementById('exerciseModal').classList.add('active');
}
function closeExerciseManager() { document.getElementById('exerciseModal').classList.remove('active'); }
function addExercise() {
  const v = document.getElementById('newExerciseInput').value.trim();
  if(v && !exercises.includes(v)) { exercises.push(v); saveExercises(); renderExercises(); openExerciseManager(); document.getElementById('newExerciseInput').value=''; }
}
function removeExercise(i) {
  if(confirm('Удалить?')) { exercises.splice(i,1); saveExercises(); renderExercises(); openExerciseManager(); }
}
</script>
</body>
</html>
