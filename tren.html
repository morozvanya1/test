<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>FitTrack Pro</title>
  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1c1c1e;
      --input-bg: #2c2c2e;
      --primary: #0A84FF;
      --primary-dark: #0056b3;
      --danger: #FF453A;
      --success: #32D74B;
      --warning: #FFD60A;
      --text: #FFFFFF;
      --text-secondary: #8E8E93;
      --separator: #38383A;
      --radius: 14px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: var(--bg-color); 
      color: var(--text);
      padding-top: var(--safe-top);
      padding-bottom: calc(80px + var(--safe-bottom));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.4;
    }

    /* Header */
    .header-sticky {
      position: sticky; 
      top: 0; 
      z-index: 100;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px); 
      -webkit-backdrop-filter: blur(20px);
      padding: 10px 20px;
      border-bottom: 0.5px solid var(--separator);
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: var(--transition);
    }
    
    h1 { 
      font-size: 22px; 
      font-weight: 700; 
      margin: 0; 
      background: linear-gradient(90deg, var(--primary), #5AC8FA);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .container { 
      padding: 20px; 
      max-width: 500px; 
      margin: 0 auto; 
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h3 { 
      color: var(--text-secondary); 
      font-size: 13px; 
      text-transform: uppercase; 
      margin: 24px 0 8px 16px; 
      letter-spacing: 0.5px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      font-weight: 600;
    }

    .card { 
      background: var(--card-bg); 
      border-radius: var(--radius); 
      overflow: hidden; 
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
    }

    .input-row {
      padding: 12px 16px;
      background: var(--card-bg);
      border-bottom: 0.5px solid var(--separator);
      transition: var(--transition);
    }
    
    .input-row:focus-within {
      background: rgba(44, 44, 46, 0.8);
    }
    
    .input-row:last-child { border-bottom: none; }

    select, input {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--separator);
      border-radius: 8px;
      color: var(--text);
      font-size: 17px;
      padding: 12px;
      -webkit-appearance: none;
      appearance: none;
      transition: var(--transition);
      font-family: inherit;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
    }
    
    .select-wrapper { 
      position: relative; 
    }
    
    .select-wrapper::after {
      content: '‚ñº';
      font-size: 10px; 
      color: var(--text-secondary);
      position: absolute; 
      right: 16px; 
      top: 50%; 
      transform: translateY(-50%);
      pointer-events: none;
      transition: var(--transition);
    }
    
    select:focus + .select-wrapper::after {
      color: var(--primary);
    }

    input::placeholder { 
      color: var(--text-secondary); 
      opacity: 0.7;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Buttons */
    button {
      background: var(--primary); 
      color: white; 
      border: none;
      font-size: 17px; 
      font-weight: 600; 
      padding: 14px 20px;
      border-radius: var(--radius); 
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(40, 40);
        opacity: 0;
      }
    }
    
    button:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    button:active { 
      transform: scale(0.98); 
    }
    
    button.secondary { 
      background: rgba(118, 118, 128, 0.24); 
      color: var(--primary); 
    }
    
    button.secondary:hover {
      background: rgba(118, 118, 128, 0.32);
    }
    
    button.icon-only { 
      background: transparent; 
      width: auto; 
      padding: 8px; 
      border-radius: 50%;
    }
    
    button.icon-only:hover {
      background: rgba(118, 118, 128, 0.12);
    }
    
    .btn-export {
      background: rgba(118, 118, 128, 0.24);
      color: var(--primary);
      font-size: 12px;
      padding: 4px 12px;
      border-radius: 12px;
      text-transform: none;
      width: auto;
      letter-spacing: 0;
      font-weight: 500;
    }
    
    .btn-export:hover {
      background: rgba(118, 118, 128, 0.32);
    }

    /* Sets Layout */
    .set-row {
      display: flex; 
      align-items: center; 
      padding: 14px 16px;
      border-bottom: 0.5px solid var(--separator);
      transition: var(--transition);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .set-row:hover {
      background: rgba(44, 44, 46, 0.3);
    }
    
    .set-index { 
      width: 24px; 
      color: var(--text-secondary); 
      font-size: 15px; 
      font-weight: 500;
    }
    
    .set-inputs { 
      display: flex; 
      gap: 12px; 
      flex: 1; 
    }
    
    .set-inputs input {
      background: var(--input-bg);
      text-align: center;
      font-weight: 600;
    }
    
    .btn-delete {
      width: 32px; 
      height: 32px; 
      background: var(--danger); 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin-left: 10px; 
      padding: 0;
      transition: var(--transition);
    }
    
    .btn-delete:hover {
      background: #d43530;
      transform: scale(1.1);
    }
    
    .btn-delete:active {
      transform: scale(0.9);
    }
    
    .btn-delete svg { 
      width: 14px; 
      height: 14px; 
      fill: white; 
    }

    /* Stats */
    .stats-row {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(10, 132, 255, 0.1);
      border-radius: var(--radius);
      margin: 10px 0 20px 0;
      animation: fadeIn 0.5s ease-out;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* History */
    .history-group { 
      margin-bottom: 24px; 
    }
    
    .history-date { 
      font-size: 20px; 
      font-weight: 700; 
      margin: 0 0 12px 4px; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .history-date::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    .history-item { 
      background: var(--card-bg); 
      padding: 16px; 
      margin-bottom: 1px; 
      transition: var(--transition);
      animation: slideIn 0.3s ease-out;
    }
    
    .history-item:hover {
      background: rgba(44, 44, 46, 0.8);
    }
    
    .history-item:first-child { 
      border-top-left-radius: var(--radius); 
      border-top-right-radius: var(--radius); 
    }
    
    .history-item:last-child { 
      border-bottom-left-radius: var(--radius); 
      border-bottom-right-radius: var(--radius); 
    }
    
    .tag { 
      font-size: 13px; 
      background: rgba(10, 132, 255, 0.15); 
      color: var(--primary); 
      padding: 4px 10px; 
      border-radius: 6px; 
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .tag:hover {
      background: rgba(10, 132, 255, 0.25);
      transform: translateY(-1px);
    }

    /* FAB */
    .fab-container {
      position: fixed; 
      bottom: calc(20px + var(--safe-bottom));
      left: 20px; 
      right: 20px; 
      max-width: 500px; 
      margin: 0 auto; 
      z-index: 90;
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modal */
    .modal {
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000; 
      display: none; 
      align-items: flex-end;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal.active { 
      display: flex; 
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-card {
      background: var(--card-bg); 
      width: 100%; 
      border-radius: 20px 20px 0 0;
      padding: 20px; 
      padding-bottom: calc(20px + var(--safe-bottom));
      max-height: 85vh; 
      display: flex; 
      flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
    }
    
    @keyframes slideUp { 
      from { transform: translateY(100%); } 
      to { transform: translateY(0); } 
    }
    
    .modal-handle {
      width: 40px; 
      height: 5px; 
      background: var(--separator); 
      border-radius: 100px; 
      margin: -10px auto 20px auto;
      cursor: grab;
    }
    
    .modal-handle:active {
      cursor: grabbing;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      fill: var(--text-secondary);
      opacity: 0.3;
      margin-bottom: 16px;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid var(--primary);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    .toast.warning { border-color: var(--warning); }

    /* Loader */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-secondary);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container { padding: 16px; }
      .header-sticky { padding: 10px 16px; }
      .set-inputs { flex-direction: column; gap: 8px; }
      .stats-row { flex-wrap: wrap; }
      .stat-item { min-width: calc(50% - 5px); }
    }

    /* Dark mode preference */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-color: #f2f2f7;
        --card-bg: #ffffff;
        --input-bg: #e5e5ea;
        --text: #000000;
        --text-secondary: #8e8e93;
        --separator: #c6c6c8;
      }
    }
  </style>
</head>
<body>

<div class="header-sticky">
  <h1>FitTrack Pro</h1>
  <div style="display:flex; gap: 10px;">
    <button class="icon-only" onclick="openExerciseManager()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏">‚öôÔ∏è</button>
    <button class="icon-only" id="lockBtn" onclick="toggleEditMode()" title="–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">üîí</button>
    <button class="icon-only" onclick="showStats()" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
  </div>
</div>

<div class="container">
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
  <div id="workoutStats" class="stats-row" style="display: none;">
    <div class="stat-item">
      <div class="stat-value" id="totalVolume">0</div>
      <div class="stat-label">–û–±—ä–µ–º (–∫–≥)</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalSets">0</div>
      <div class="stat-label">–ü–æ–¥—Ö–æ–¥—ã</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="bestSet">-</div>
      <div class="stat-label">–õ—É—á—à–∏–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="avgWeight">0</div>
      <div class="stat-label">–°—Ä. –≤–µ—Å</div>
    </div>
  </div>

  <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
  <div class="card">
    <div class="input-row">
      <div class="select-wrapper">
        <select id="exerciseSelect" onchange="loadLastSessionHint()"></select>
      </div>
    </div>
    <div class="input-row" id="lastSessionHint" style="display:none; padding-top:8px;">
      <div id="hintText" style="font-size:13px; color:var(--primary); display: flex; justify-content: space-between; align-items: center;"></div>
    </div>
  </div>

  <h3>
    –ü–æ–¥—Ö–æ–¥—ã
    <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">
      <span id="completedSets">0</span>/<span id="totalSetsCount">0</span>
    </span>
  </h3>
  <div class="card" id="setsContainer"></div>
  
  <button class="secondary" onclick="addSet()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–µ—Å–∞ -->
  <div style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding: 8px 0;">
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(20)">20 –∫–≥</button>
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(40)">40 –∫–≥</button>
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(60)">60 –∫–≥</button>
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(80)">80 –∫–≥</button>
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(100)">100 –∫–≥</button>
    <button class="secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="quickWeight(0)">–°–±—Ä–æ—Å</button>
  </div>

  <h3>
    –ò—Å—Ç–æ—Ä–∏—è
    <div style="display: flex; gap: 8px;">
      <button class="btn-export" onclick="exportToExcel()">üìä Excel</button>
      <button class="btn-export" onclick="clearHistory()" style="color: var(--danger);">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </h3>
  
  <div class="card" style="padding:16px; background: transparent;">
     <div style="margin-bottom: 12px;">
        <div class="select-wrapper">
           <select id="filterExercise" onchange="renderHistory()">
             <option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
           </select>
        </div>
     </div>
     <div id="historyList">
       <div class="empty-state" id="emptyHistory">
         <svg viewBox="0 0 24 24">
           <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
         </svg>
         <p>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø—É—Å—Ç–∞</p>
         <p style="font-size: 14px; margin-top: 8px;">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!</p>
       </div>
     </div>
  </div>

  <br><br><br>
</div>

<div class="fab-container">
  <button onclick="saveWorkout()" id="saveBtn" style="box-shadow: var(--shadow);">
    <span id="saveBtnText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span>
    <span id="saveBtnLoader" class="loader" style="display: none; margin-left: 8px;"></span>
  </button>
</div>

<!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="toast" class="toast"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
<div class="modal" id="exerciseModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeExerciseManager()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
    <input 
      type="text" 
      id="searchExercise" 
      placeholder="üîç –ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π..." 
      style="margin-bottom: 15px;"
      oninput="filterExercises()"
    >
    <div style="overflow-y:auto; flex:1; margin-bottom:15px; min-height: 200px;" id="exerciseManagerList"></div>
    <div style="display:flex; gap:10px;">
      <input id="newExerciseInput" placeholder="–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" onkeypress="if(event.key === 'Enter') addExercise()">
      <button onclick="addExercise()" style="width:auto; min-width: 60px;">‚ûï</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="modal" id="statsModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeStats()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="overflow-y:auto; flex:1; padding: 10px;" id="statsContent">
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>
</div>

<script>
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const STORAGE_KEY = 'fitness_data_v4';
const EXERCISE_KEY = 'fitness_exercises_v4';
const SETTINGS_KEY = 'fitness_settings_v1';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã/–æ–±—ä–µ–∫—Ç—ã
let appData = [];
let exercises = [];
let currentSets = [];
let editMode = false;
let editingId = null;
let settings = {};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = () => {
  // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
  appData = [];
  exercises = [];
  currentSets = [];
  settings = {};
  
  // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  loadData();
  renderExercises();
  renderHistory();
  addSet();
  updateStats();
  loadSettings();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ sessionStorage
  const savedSets = sessionStorage.getItem('currentSets');
  if (savedSets) {
    try {
      currentSets = JSON.parse(savedSets);
      if (!Array.isArray(currentSets)) currentSets = [];
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ savedSets:', e);
      currentSets = [];
    }
    renderSets();
  }
  
  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', autoSaveCurrentSets);
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) autoSaveCurrentSets();
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  setTimeout(() => {
    if (!initDOMCheck()) {
      console.error('–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞', 'error');
    }
  }, 100);
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
function loadData() {
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º appData
    const storedAppData = localStorage.getItem(STORAGE_KEY);
    if (storedAppData) {
      const parsed = JSON.parse(storedAppData);
      appData = Array.isArray(parsed) ? parsed : [];
    } else {
      appData = [];
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º exercises
    const storedExercises = localStorage.getItem(EXERCISE_KEY);
    if (storedExercises) {
      const parsed = JSON.parse(storedExercises);
      exercises = Array.isArray(parsed) ? parsed : [];
    } else {
      exercises = [];
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º settings
    const storedSettings = localStorage.getItem(SETTINGS_KEY);
    if (storedSettings) {
      try {
        settings = JSON.parse(storedSettings);
        if (typeof settings !== 'object' || settings === null) {
          settings = {};
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
        settings = {};
      }
    } else {
      settings = {};
    }
    
    // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
    if (!exercises.length) {
      exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
      saveExercises();
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    appData = [];
    exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
    settings = {};
    
    // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    try {
      localStorage.setItem(EXERCISE_KEY, JSON.stringify(exercises));
    } catch (e2) {
      console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:', e2);
    }
  }
}

function loadSettings() {
  if (!settings.defaultWeight) settings.defaultWeight = 20;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
function saveData() {
  try {
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ appData - —ç—Ç–æ –º–∞—Å—Å–∏–≤
    if (!Array.isArray(appData)) {
      console.warn('appData –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
      appData = [];
    }
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
}

function saveExercises() {
  try {
    localStorage.setItem(EXERCISE_KEY, JSON.stringify(exercises));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', e);
  }
}

function saveSettings() {
  try {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
  }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
function autoSaveCurrentSets() {
  if (currentSets.some(set => set.weight || set.reps)) {
    sessionStorage.setItem('currentSets', JSON.stringify(currentSets));
  }
}

// –†–∞–±–æ—Ç–∞ —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏
function addSet() {
  const lastSet = currentSets.length > 0 
    ? currentSets[currentSets.length - 1] 
    : { reps: '', weight: settings.defaultWeight || '' };
    
  currentSets.push({ 
    id: Date.now() + Math.random(), 
    reps: lastSet.reps, 
    weight: lastSet.weight 
  });
  
  renderSets();
  updateStats();
  showToast('–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥', 'success');
}

function removeSet(idx) {
  if (currentSets.length > 1) {
    currentSets.splice(idx, 1);
    showToast('–ü–æ–¥—Ö–æ–¥ —É–¥–∞–ª–µ–Ω', 'warning');
  } else {
    currentSets[0] = { reps: '', weight: '' };
  }
  
  renderSets();
  updateStats();
}

function updateSet(idx, field, value) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
  if (field === 'weight' || field === 'reps') {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ç–æ—á–∫–∏
    value = value.replace(/[^\d.]/g, '');
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const numValue = parseFloat(value);
    if (field === 'weight' && numValue > 1000) value = '1000';
    if (field === 'reps' && numValue > 200) value = '200';
  }
  
  if (currentSets[idx]) {
    currentSets[idx][field] = value;
  }
  
  updateStats();
  
  // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª–µ
  if (field === 'weight' && value && currentSets[idx]?.reps === '') {
    const nextInput = document.querySelector(`.set-row:nth-child(${idx + 1}) input[placeholder="–ø–æ–≤—Ç"]`);
    if (nextInput) nextInput.focus();
  }
}

function renderSets() {
  const container = document.getElementById('setsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (currentSets.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 30px 20px;">
        <svg viewBox="0 0 24 24">
          <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
        </svg>
        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥—Ö–æ–¥—ã</p>
      </div>
    `;
    return;
  }
  
  currentSets.forEach((set, i) => {
    const row = document.createElement('div');
    row.className = 'set-row';
    row.innerHTML = `
      <span class="set-index">${i + 1}</span>
      <div class="set-inputs">
        <input 
          type="number" 
          placeholder="–∫–≥" 
          value="${set.weight || ''}" 
          oninput="updateSet(${i},'weight',this.value)"
          min="0" 
          max="1000"
          step="0.5"
        >
        <input 
          type="number" 
          placeholder="–ø–æ–≤—Ç" 
          value="${set.reps || ''}" 
          oninput="updateSet(${i},'reps',this.value)"
          min="0" 
          max="200"
          step="1"
        >
      </div>
      <button class="btn-delete" onclick="removeSet(${i})" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">
        <svg viewBox="0 0 24 24">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    `;
    container.appendChild(row);
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–¥—Ö–æ–¥–æ–≤
  const completedSets = currentSets.filter(s => s.reps && s.weight).length;
  document.getElementById('completedSets').textContent = completedSets;
  document.getElementById('totalSetsCount').textContent = currentSets.length;
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function updateStats() {
  const validSets = currentSets.filter(s => s.reps && s.weight);
  const statsContainer = document.getElementById('workoutStats');
  
  if (!statsContainer) return;
  
  if (validSets.length === 0) {
    statsContainer.style.display = 'none';
    return;
  }
  
  statsContainer.style.display = 'flex';
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const totalVolume = validSets.reduce((sum, set) => {
    const weight = parseFloat(set.weight) || 0;
    const reps = parseInt(set.reps) || 0;
    return sum + (weight * reps);
  }, 0);
  
  const totalWeight = validSets.reduce((sum, set) => {
    return sum + (parseFloat(set.weight) || 0);
  }, 0);
  
  const bestSet = validSets.reduce((best, set) => {
    const weight = parseFloat(set.weight) || 0;
    const reps = parseInt(set.reps) || 0;
    const current = weight * reps;
    return current > best.value ? { set, value: current } : best;
  }, { set: null, value: 0 });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  document.getElementById('totalVolume').textContent = Math.round(totalVolume);
  document.getElementById('totalSets').textContent = validSets.length;
  document.getElementById('bestSet').textContent = bestSet.set 
    ? `${bestSet.set.weight}√ó${bestSet.set.reps}`
    : '-';
  document.getElementById('avgWeight').textContent = 
    validSets.length > 0 ? Math.round(totalWeight / validSets.length) : 0;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
async function saveWorkout() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ saveWorkout, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
  }
  
  const name = document.getElementById('exerciseSelect').value;
  const validSets = currentSets.filter(s => s.reps && s.weight);
  
  if (!name || name === '–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...') {
    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', 'error');
    return;
  }
  
  if (!validSets.length) {
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥', 'error');
    return;
  }
  
  // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
  if (navigator.vibrate) navigator.vibrate(50);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  const saveBtn = document.getElementById('saveBtn');
  const saveBtnText = document.getElementById('saveBtnText');
  const saveBtnLoader = document.getElementById('saveBtnLoader');
  
  if (!saveBtn || !saveBtnText || !saveBtnLoader) {
    showToast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞', 'error');
    return;
  }
  
  saveBtn.disabled = true;
  saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  saveBtnLoader.style.display = 'inline-block';
  
  // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è UX
  await new Promise(resolve => setTimeout(resolve, 500));
  
  const record = {
    id: editingId || Date.now() + '-' + Math.random().toString(36).substr(2, 9),
    name,
    sets: JSON.parse(JSON.stringify(validSets)),
    date: editingId ? (appData.find(x => x.id === editingId)?.date || Date.now()) : Date.now(),
    volume: validSets.reduce((sum, set) => {
      const weight = parseFloat(set.weight) || 0;
      const reps = parseInt(set.reps) || 0;
      return sum + (weight * reps);
    }, 0)
  };
  
  if (editingId) {
    const index = appData.findIndex(x => x.id === editingId);
    if (index !== -1) {
      appData[index] = record;
    } else {
      // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—É—é
      appData.push(record);
    }
    editingId = null;
    saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
  } else {
    appData.push(record);
  }
  
  saveData();
  currentSets = [];
  sessionStorage.removeItem('currentSets');
  renderSets();
  renderHistory();
  updateStats();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  saveBtn.disabled = false;
  saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
  saveBtnLoader.style.display = 'none';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  showToast(editingId ? '–¢—Ä–µ–Ω–µ—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
  
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∏—Å—Ç–æ—Ä–∏–∏
  const historyList = document.querySelector('#historyList');
  if (historyList) {
    window.scrollTo({
      top: historyList.offsetTop - 100,
      behavior: 'smooth'
    });
  }
}

// –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
function renderHistory() {
  const container = document.getElementById('historyList');
  const emptyState = document.getElementById('emptyHistory');
  const filterSelect = document.getElementById('filterExercise');
  
  if (!container) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
  const filter = filterSelect ? filterSelect.value : '';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ renderHistory, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
  }
  
  if (!appData.length) {
    if (emptyState) emptyState.style.display = 'block';
    container.innerHTML = '';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  container.innerHTML = '';
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
  let filteredData = appData;
  if (filter) {
    filteredData = appData.filter(item => item.name === filter);
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  const sortedData = [...filteredData].sort((a, b) => {
    const dateA = a.date || 0;
    const dateB = b.date || 0;
    return dateB - dateA;
  });
  
  if (sortedData.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <p>–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</p>
      </div>
    `;
    return;
  }
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
  const grouped = sortedData.reduce((groups, item) => {
    const date = new Date(item.date).toLocaleDateString('ru-RU', {
      weekday: 'long',
      day: 'numeric',
      month: 'long'
    });
    
    if (!groups[date]) groups[date] = [];
    groups[date].push(item);
    return groups;
  }, {});
  
  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä—É–ø–ø
  Object.entries(grouped).forEach(([date, items]) => {
    const groupElement = document.createElement('div');
    groupElement.className = 'history-group';
    
    groupElement.innerHTML = `
      <div class="history-date">
        ${date}
        <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">
          (${items.length} ${getPluralForm(items.length, ['—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫'])})
        </span>
      </div>
    `;
    
    items.forEach(item => {
      if (!item.sets || !Array.isArray(item.sets)) {
        console.warn('–£ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç sets –∏–ª–∏ —ç—Ç–æ –Ω–µ –º–∞—Å—Å–∏–≤:', item);
        return;
      }
      
      const itemElement = document.createElement('div');
      itemElement.className = 'history-item';
      
      const totalVolume = item.sets.reduce((sum, set) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        return sum + (weight * reps);
      }, 0);
      
      const setsHtml = item.sets.map((set, index) => `
        <span class="tag" title="–ü–æ–¥—Ö–æ–¥ ${index + 1}">
          ${set.weight || 0}–∫–≥ √ó ${set.reps || 0}
        </span>
      `).join('');
      
      const actions = editMode ? `
        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
          <button class="secondary" 
            style="width: auto; padding: 6px 12px; font-size: 13px;" 
            onclick="editRec('${item.id}')"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
          </button>
          <button class="secondary" 
            style="width: auto; padding: 6px 12px; font-size: 13px; color: var(--danger);" 
            onclick="delRec('${item.id}')"
            title="–£–¥–∞–ª–∏—Ç—å">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      ` : '';
      
      itemElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start;">
          <div>
            <b style="font-size: 16px;">${item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</b>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              ${new Date(item.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
              ‚Ä¢ ${item.sets.length} ${getPluralForm(item.sets.length, ['–ø–æ–¥—Ö–æ–¥', '–ø–æ–¥—Ö–æ–¥–∞', '–ø–æ–¥—Ö–æ–¥–æ–≤'])}
              ‚Ä¢ ${Math.round(totalVolume)} –∫–≥ –æ–±—â–∏–π –æ–±—ä–µ–º
            </div>
          </div>
          <div style="font-size: 14px; color: var(--primary); font-weight: 600;">
            ${Math.round(totalVolume)} –∫–≥
          </div>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
          ${setsHtml}
        </div>
        ${actions}
      `;
      
      groupElement.appendChild(itemElement);
    });
    
    container.appendChild(groupElement);
  });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è
function getPluralForm(n, forms) {
  n = Math.abs(n) % 100;
  const n1 = n % 10;
  if (n > 10 && n < 20) return forms[2];
  if (n1 > 1 && n1 < 5) return forms[1];
  if (n1 === 1) return forms[0];
  return forms[2];
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function editRec(id) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ editRec, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    return;
  }
  
  const record = appData.find(x => x.id === id);
  if (!record) {
    showToast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
    return;
  }
  
  document.getElementById('exerciseSelect').value = record.name;
  currentSets = JSON.parse(JSON.stringify(record.sets || []));
  editingId = id;
  
  const saveBtn = document.querySelector('.fab-container button');
  if (saveBtn) {
    saveBtn.innerHTML = '<span id="saveBtnText">–û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span><span id="saveBtnLoader" class="loader" style="display: none; margin-left: 8px;"></span>';
  }
  
  renderSets();
  updateStats();
  
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≤–µ—Ä—Ö—É
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  
  showToast('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', 'warning');
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function delRec(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ delRec, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    renderHistory();
    return;
  }
  
  appData = appData.filter(x => x.id !== id);
  saveData();
  renderHistory();
  showToast('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'error');
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
function clearHistory() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
    return;
  }
  
  appData = [];
  saveData();
  renderHistory();
  showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞', 'error');
}

// –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
function toggleEditMode() {
  editMode = !editMode;
  const lockBtn = document.getElementById('lockBtn');
  
  if (!lockBtn) return;
  
  if (editMode) {
    lockBtn.style.opacity = '1';
    lockBtn.style.color = 'var(--primary)';
    lockBtn.title = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω';
    showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω', 'warning');
  } else {
    lockBtn.style.opacity = '0.5';
    lockBtn.style.color = '';
    lockBtn.title = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω';
    showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω', 'success');
  }
  
  renderHistory();
}

// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø—Ä–æ—à–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
function loadLastSessionHint() {
  const name = document.getElementById('exerciseSelect').value;
  const hint = document.getElementById('lastSessionHint');
  
  if (!name || name === '–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...' || !hint) {
    if (hint) hint.style.display = 'none';
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ loadLastSessionHint, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    hint.style.display = 'none';
    return;
  }
  
  const lastSessions = appData
    .filter(x => x.name === name)
    .sort((a, b) => b.date - a.date);
  
  if (lastSessions.length > 0) {
    const last = lastSessions[0];
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É last –µ—Å—Ç—å sets
    if (!last.sets || !Array.isArray(last.sets) || last.sets.length === 0) {
      hint.style.display = 'none';
      return;
    }
    
    const bestSet = last.sets.reduce((max, set) => {
      const weight = parseFloat(set.weight) || 0;
      const reps = parseInt(set.reps) || 0;
      const current = weight * reps;
      return current > max.value ? { set, value: current } : max;
    }, { set: null, value: 0 });
    
    if (bestSet.set) {
      const totalVolume = last.sets.reduce((sum, set) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        return sum + (weight * reps);
      }, 0);
      
      const daysAgo = Math.floor((Date.now() - last.date) / (1000 * 60 * 60 * 24));
      const daysText = daysAgo === 0 ? '—Å–µ–≥–æ–¥–Ω—è' : 
                      daysAgo === 1 ? '–≤—á–µ—Ä–∞' : 
                      `${daysAgo} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
      
      document.getElementById('hintText').innerHTML = `
        <span>
          <strong>${daysText}:</strong> ${bestSet.set.weight}–∫–≥ √ó ${bestSet.set.reps} (–ª—É—á—à–∏–π)
        </span>
        <span style="color: var(--text-secondary); font-size: 12px;">
          ${last.sets.length} –ø–æ–¥—Ö–æ–¥–∞ ‚Ä¢ ${Math.round(totalVolume)}–∫–≥
        </span>
      `;
      
      hint.style.display = 'block';
    } else {
      hint.style.display = 'none';
    }
  } else {
    hint.style.display = 'none';
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏
function renderExercises() {
  const select = document.getElementById('exerciseSelect');
  const filter = document.getElementById('filterExercise');
  
  if (!select || !filter) return;
  
  const oldSelectValue = select.value;
  const oldFilterValue = filter.value;
  
  // –û—á–∏—â–∞–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  select.innerHTML = '<option disabled selected>–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...</option>';
  filter.innerHTML = '<option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ exercises - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(exercises)) {
    console.warn('exercises –Ω–µ –º–∞—Å—Å–∏–≤, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
    saveExercises();
  }
  
  [...exercises].sort().forEach(exercise => {
    select.add(new Option(exercise, exercise));
    filter.add(new Option(exercise, exercise));
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
  if (exercises.includes(oldSelectValue)) select.value = oldSelectValue;
  if (exercises.includes(oldFilterValue)) filter.value = oldFilterValue;
}

function openExerciseManager() {
  renderExerciseManagerList();
  document.getElementById('exerciseModal').classList.add('active');
  document.getElementById('newExerciseInput').focus();
}

function closeExerciseManager() {
  document.getElementById('exerciseModal').classList.remove('active');
  renderExercises();
}

function renderExerciseManagerList() {
  const container = document.getElementById('exerciseManagerList');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (exercises.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px;">
        <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
      </div>
    `;
    return;
  }
  
  [...exercises].sort().forEach((exercise, index) => {
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'input-row';
    exerciseElement.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 4px;
    `;
    
    exerciseElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
        <span style="color: var(--text-secondary); font-size: 12px; width: 24px;">${index + 1}.</span>
        <span style="flex: 1;">${exercise}</span>
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="icon-only" onclick="renameExercise(${index})" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" style="font-size: 12px;">‚úèÔ∏è</button>
        <button class="icon-only" onclick="removeExercise(${index})" title="–£–¥–∞–ª–∏—Ç—å" style="color: var(--danger);">üóëÔ∏è</button>
      </div>
    `;
    
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    exerciseElement.ondblclick = () => {
      document.getElementById('exerciseSelect').value = exercise;
      closeExerciseManager();
      loadLastSessionHint();
    };
    
    container.appendChild(exerciseElement);
  });
}

function filterExercises() {
  const searchTerm = document.getElementById('searchExercise').value.toLowerCase();
  const container = document.getElementById('exerciseManagerList');
  if (!container) return;
  
  const items = container.getElementsByClassName('input-row');
  
  Array.from(items).forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
  });
}

function addExercise() {
  const input = document.getElementById('newExerciseInput');
  if (!input) return;
  
  const value = input.value.trim();
  
  if (!value) {
    showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', 'error');
    input.focus();
    return;
  }
  
  if (exercises.includes(value)) {
    showToast('–≠—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
    input.focus();
    return;
  }
  
  exercises.push(value);
  saveExercises();
  renderExerciseManagerList();
  input.value = '';
  input.focus();
  
  showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${value}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');
}

function removeExercise(index) {
  const exerciseName = exercises[index];
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exerciseName}"?\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.`)) {
    return;
  }
  
  exercises.splice(index, 1);
  saveExercises();
  renderExerciseManagerList();
  
  showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exerciseName}" —É–¥–∞–ª–µ–Ω–æ`, 'warning');
}

function renameExercise(index) {
  const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', exercises[index]);
  
  if (newName && newName.trim() && newName.trim() !== exercises[index]) {
    if (exercises.includes(newName.trim())) {
      showToast('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
      return;
    }
    
    const oldName = exercises[index];
    exercises[index] = newName.trim();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å —ç—Ç–∏–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
    appData.forEach(record => {
      if (record.name === oldName) {
        record.name = newName.trim();
      }
    });
    
    saveExercises();
    saveData();
    renderExerciseManagerList();
    renderExercises();
    
    showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: "${oldName}" ‚Üí "${newName.trim()}"`, 'success');
  }
}

// –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–µ—Å–∞
function quickWeight(weight) {
  if (weight === 0) {
    currentSets.forEach(set => {
      set.weight = '';
      set.reps = '';
    });
  } else {
    currentSets.forEach(set => {
      if (!set.weight) set.weight = weight;
    });
  }
  
  renderSets();
  updateStats();
  showToast(weight === 0 ? '–í–µ—Å–∞ —Å–±—Ä–æ—à–µ–Ω—ã' : `–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–µ—Å ${weight}–∫–≥`, 'success');
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
function exportToExcel() {
  if (!appData.length) {
    showToast('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞', 'warning');
    return;
  }
  
  try {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
    csvContent += "–î–∞—Ç–∞;–í—Ä–µ–º—è;–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ;–ü–æ–¥—Ö–æ–¥;–í–µ—Å (–∫–≥);–ü–æ–≤—Ç–æ—Ä—ã;–û–±—ä–µ–º\n";
    
    const sortedData = [...appData].sort((a, b) => a.date - b.date);
    
    sortedData.forEach(workout => {
      const date = new Date(workout.date);
      const dateStr = date.toLocaleDateString('ru-RU');
      const timeStr = date.toLocaleTimeString('ru-RU');
      
      workout.sets.forEach((set, index) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        const volume = weight * reps;
        csvContent += `${dateStr};${timeStr};"${workout.name}";${index + 1};"${weight}";"${reps}";"${volume}"\n`;
      });
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `fitness_history_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ', 'error');
  }
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
function showStats() {
  const container = document.getElementById('statsContent');
  if (!container) return;
  
  if (!appData.length) {
    container.innerHTML = `
      <div class="empty-state">
        <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
      </div>
    `;
    document.getElementById('statsModal').classList.add('active');
    return;
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const totalWorkouts = appData.length;
  const totalExercises = [...new Set(appData.map(w => w.name))].length;
  const totalSets = appData.reduce((sum, w) => sum + w.sets.length, 0);
  const totalVolume = appData.reduce((sum, w) => sum + (w.volume || 0), 0);
  
  // –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  const exerciseCounts = appData.reduce((acc, w) => {
    acc[w.name] = (acc[w.name] || 0) + 1;
    return acc;
  }, {});
  
  const popularExercises = Object.entries(exerciseCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  const firstWorkout = new Date(Math.min(...appData.map(w => w.date)));
  const daysSinceStart = Math.floor((Date.now() - firstWorkout) / (1000 * 60 * 60 * 24));
  
  container.innerHTML = `
    <div class="stats-row" style="margin: 0 0 20px 0;">
      <div class="stat-item">
        <div class="stat-value">${totalWorkouts}</div>
        <div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${totalExercises}</div>
        <div class="stat-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${totalSets}</div>
        <div class="stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${Math.round(totalVolume)}</div>
        <div class="stat-label">–∫–≥ –æ–±—â–∏–π –æ–±—ä–µ–º</div>
      </div>
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 20px;">
      ${popularExercises.map(([name, count], index) => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: ${index < popularExercises.length - 1 ? '1px solid var(--separator)' : 'none'};">
          <span>${index + 1}. ${name}</span>
          <span style="color: var(--primary); font-weight: 600;">${count} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span>
        </div>
      `).join('')}
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px;">
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–ù–∞—á–∞–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:</span>
        <span>${firstWorkout.toLocaleDateString('ru-RU')}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–î–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:</span>
        <span>${daysSinceStart}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–°—Ä–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</span>
        <span>${Math.round(totalVolume / totalWorkouts)} –∫–≥</span>
      </div>
    </div>
  `;
  
  document.getElementById('statsModal').classList.add('active');
}

function closeStats() {
  document.getElementById('statsModal').classList.remove('active');
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  let icon = '‚ÑπÔ∏è';
  if (type === 'success') icon = '‚úÖ';
  if (type === 'error') icon = '‚ùå';
  if (type === 'warning') icon = '‚ö†Ô∏è';
  
  toast.innerHTML = `${icon} ${message}`;
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
function initDOMCheck() {
  const requiredElements = [
    'exerciseSelect',
    'filterExercise',
    'setsContainer',
    'historyList',
    'saveBtn',
    'exerciseModal',
    'statsModal',
    'toast'
  ];
  
  let allExist = true;
  requiredElements.forEach(id => {
    if (!document.getElementById(id)) {
      console.error(`–≠–ª–µ–º–µ–Ω—Ç —Å id "${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
      allExist = false;
    }
  });
  
  return allExist;
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.querySelectorAll('.modal-card').forEach(card => {
  card.addEventListener('click', (e) => {
    e.stopPropagation();
  });
});

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', (e) => {
  // Ctrl+S –∏–ª–∏ Cmd+S –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveWorkout();
  }
  
  // Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      modal.classList.remove('active');
    });
  }
  
  // + –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞
  if (e.key === '+' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    addSet();
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
});

document.addEventListener('touchend', (e) => {
  const touchEndX = e.changedTouches[0].screenX;
  const touchEndY = e.changedTouches[0].screenY;
  
  const diffX = touchEndX - touchStartX;
  const diffY = touchEndY - touchStartY;
  
  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if (Math.abs(diffX) > 50 && Math.abs(diffY) < 30) {
    if (diffX > 0) {
      // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ
      const saveBtn = document.querySelector('.fab-container button');
      if (saveBtn) {
        saveBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          saveBtn.style.transform = '';
          saveWorkout();
        }, 100);
      }
    }
  }
});
</script>
</body>
</html>
