<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>FitTrack Pro</title>
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    :root {
      --bg-color: #000000;
      --card-bg: #1c1c1e;
      --input-bg: #2c2c2e;
      --primary: #0A84FF;
      --primary-dark: #0056b3;
      --danger: #FF453A;
      --success: #32D74B;
      --warning: #FFD60A;
      --text: #FFFFFF;
      --text-secondary: #8E8E93;
      --separator: #38383A;
      --radius: 14px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      --transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: var(--bg-color); 
      color: var(--text);
      padding-top: var(--safe-top);
      padding-bottom: calc(90px + var(--safe-bottom));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.4;
      min-height: -webkit-fill-available;
    }

    /* Updated Header Design */
    .header-sticky {
      position: sticky; 
      top: 0; 
      z-index: 100;
      background: rgba(28, 28, 30, 0.98);
      backdrop-filter: blur(30px); 
      -webkit-backdrop-filter: blur(30px);
      padding: 12px 16px;
      border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      transition: var(--transition);
      padding-top: max(12px, var(--safe-top));
    }
    
    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .app-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .app-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), #5AC8FA);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: white;
    }
    
    .app-title {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary), #5AC8FA);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .user-selector {
      position: relative;
    }
    
    .user-selector select {
      background: rgba(118, 118, 128, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      color: var(--text);
      font-size: 14px;
      padding: 6px 12px 6px 36px;
      -webkit-appearance: none;
      appearance: none;
      min-width: 140px;
    }
    
    .user-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 14px;
      pointer-events: none;
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
    }
    
    .header-btn {
      width: 40px;
      height: 40px;
      background: rgba(118, 118, 128, 0.24);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .header-btn:hover {
      background: rgba(118, 118, 128, 0.32);
      transform: scale(1.05);
    }
    
    .header-btn.active {
      background: var(--primary);
      color: white;
    }

    .container { 
      padding: 16px; 
      max-width: 500px; 
      margin: 0 auto; 
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h3 { 
      color: var(--text-secondary); 
      font-size: 13px; 
      text-transform: uppercase; 
      margin: 20px 0 8px 0; 
      letter-spacing: 0.5px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      font-weight: 600;
      padding: 0 4px;
    }

    .card { 
      background: var(--card-bg); 
      border-radius: var(--radius); 
      overflow: hidden; 
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .input-row {
      padding: 12px 16px;
      background: var(--card-bg);
      border-bottom: 0.5px solid var(--separator);
      transition: var(--transition);
    }
    
    .input-row:focus-within {
      background: rgba(44, 44, 46, 0.8);
    }
    
    .input-row:last-child { border-bottom: none; }

    select, input {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: var(--text);
      font-size: 16px;
      padding: 12px;
      -webkit-appearance: none;
      appearance: none;
      transition: var(--transition);
      font-family: inherit;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
    }
    
    .select-wrapper { 
      position: relative; 
    }
    
    .select-wrapper::after {
      content: '‚ñº';
      font-size: 10px; 
      color: var(--text-secondary);
      position: absolute; 
      right: 16px; 
      top: 50%; 
      transform: translateY(-50%);
      pointer-events: none;
      transition: var(--transition);
    }
    
    select:focus + .select-wrapper::after {
      color: var(--primary);
    }

    input::placeholder { 
      color: var(--text-secondary); 
      opacity: 0.7;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Buttons */
    button {
      background: var(--primary); 
      color: white; 
      border: none;
      font-size: 16px; 
      font-weight: 600; 
      padding: 14px 20px;
      border-radius: var(--radius); 
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(40, 40);
        opacity: 0;
      }
    }
    
    button:hover { 
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    button:active { 
      transform: scale(0.98); 
    }
    
    button.secondary { 
      background: rgba(118, 118, 128, 0.24); 
      color: var(--primary); 
    }
    
    button.secondary:hover {
      background: rgba(118, 118, 128, 0.32);
    }
    
    .btn-export {
      background: rgba(118, 118, 128, 0.24);
      color: var(--primary);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 12px;
      text-transform: none;
      width: auto;
      letter-spacing: 0;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
    }
    
    .btn-export:hover {
      background: rgba(118, 118, 128, 0.32);
    }

    /* Sets Layout */
    .set-row {
      display: flex; 
      align-items: center; 
      padding: 12px 16px;
      border-bottom: 0.5px solid var(--separator);
      transition: var(--transition);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .set-row:hover {
      background: rgba(44, 44, 46, 0.3);
    }
    
    .set-index { 
      width: 30px; 
      color: var(--text-secondary); 
      font-size: 15px; 
      font-weight: 500;
      text-align: center;
    }
    
    .set-inputs { 
      display: flex; 
      gap: 12px; 
      flex: 1; 
    }
    
    .set-inputs input {
      background: var(--input-bg);
      text-align: center;
      font-weight: 600;
      padding: 10px;
      font-size: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .btn-delete {
      width: 32px; 
      height: 32px; 
      background: var(--danger); 
      border-radius: 50%;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      margin-left: 10px; 
      padding: 0;
      transition: var(--transition);
    }
    
    .btn-delete:hover {
      background: #d43530;
      transform: scale(1.1);
    }
    
    .btn-delete:active {
      transform: scale(0.9);
    }
    
    .btn-delete svg { 
      width: 14px; 
      height: 14px; 
      fill: white; 
    }

    /* Stats */
    .stats-row {
      display: flex;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(10, 132, 255, 0.1);
      border-radius: var(--radius);
      margin: 10px 0 20px 0;
      animation: fadeIn 0.5s ease-out;
      border: 1px solid rgba(10, 132, 255, 0.2);
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
      padding: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* History */
    .history-group { 
      margin-bottom: 20px; 
    }
    
    .history-date { 
      font-size: 18px; 
      font-weight: 700; 
      margin: 0 0 10px 0; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .history-date::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    .history-item { 
      background: var(--card-bg); 
      padding: 16px; 
      margin-bottom: 1px; 
      transition: var(--transition);
      animation: slideIn 0.3s ease-out;
    }
    
    .history-item:hover {
      background: rgba(44, 44, 46, 0.8);
    }
    
    .history-item:first-child { 
      border-top-left-radius: var(--radius); 
      border-top-right-radius: var(--radius); 
    }
    
    .history-item:last-child { 
      border-bottom-left-radius: var(--radius); 
      border-bottom-right-radius: var(--radius); 
    }
    
    .tag { 
      font-size: 13px; 
      background: rgba(10, 132, 255, 0.15); 
      color: var(--primary); 
      padding: 4px 10px; 
      border-radius: 6px; 
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .tag:hover {
      background: rgba(10, 132, 255, 0.25);
      transform: translateY(-1px);
    }

    /* FAB */
    .fab-container {
      position: fixed; 
      bottom: calc(20px + var(--safe-bottom));
      left: 16px; 
      right: 16px; 
      max-width: 500px; 
      margin: 0 auto; 
      z-index: 90;
      animation: fadeInUp 0.3s ease-out;
      bottom: max(20px, calc(20px + var(--safe-bottom)));
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Modal */
    .modal {
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000; 
      display: none; 
      align-items: flex-end;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal.active { 
      display: flex; 
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-card {
      background: var(--card-bg); 
      width: 100%; 
      border-radius: 20px 20px 0 0;
      padding: 20px; 
      padding-bottom: calc(20px + var(--safe-bottom));
      max-height: 90vh; 
      display: flex; 
      flex-direction: column;
      animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    @keyframes slideUp { 
      from { transform: translateY(100%); } 
      to { transform: translateY(0); } 
    }
    
    .modal-handle {
      width: 40px; 
      height: 5px; 
      background: var(--separator); 
      border-radius: 100px; 
      margin: -10px auto 20px auto;
      cursor: grab;
    }
    
    .modal-handle:active {
      cursor: grabbing;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      fill: var(--text-secondary);
      opacity: 0.3;
      margin-bottom: 16px;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--card-bg);
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid var(--primary);
      max-width: 90%;
      word-break: break-word;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }
    .toast.warning { border-color: var(--warning); }

    /* Loader */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--text-secondary);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Quick weight buttons */
    .quick-weight-container {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding: 8px 0;
      -webkit-overflow-scrolling: touch;
    }
    
    .quick-weight-container::-webkit-scrollbar {
      display: none;
    }
    
    .quick-weight-btn {
      background: rgba(118, 118, 128, 0.24);
      color: var(--primary);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .quick-weight-btn:hover {
      background: rgba(118, 118, 128, 0.32);
    }
    
    .quick-weight-btn.reset {
      color: var(--danger);
    }

    /* Import/Export buttons */
    .import-export-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    /* File input styling */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .file-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: rgba(118, 118, 128, 0.12);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .tab.active {
      background: var(--card-bg);
      color: var(--text);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Charts */
    .chart-container {
      width: 100%;
      height: 250px;
      position: relative;
      margin: 15px 0;
    }
    
    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* User comparison */
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .comparison-table th {
      text-align: left;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid var(--separator);
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .comparison-table td {
      padding: 12px;
      border-bottom: 1px solid var(--separator);
    }
    
    .comparison-table tr:last-child td {
      border-bottom: none;
    }
    
    .comparison-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .comparison-value {
      font-weight: 600;
      color: var(--primary);
      text-align: right;
    }

    /* User profile */
    .profile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    
    .profile-stat {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
    }
    
    .profile-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .profile-stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .profile-input-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    
    .profile-input-group input {
      flex: 1;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container { padding: 12px; }
      .header-sticky { padding: 10px 12px; }
      .set-inputs { flex-direction: column; gap: 8px; }
      .stats-row { flex-wrap: wrap; }
      .stat-item { min-width: calc(50% - 5px); }
      .app-title { font-size: 18px; }
      button { padding: 12px 16px; font-size: 15px; }
      .header-btn { width: 36px; height: 36px; }
      .profile-stats { grid-template-columns: 1fr; }
    }

    /* iPhone 13 Pro Max specific */
    @media only screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) {
      .container { padding: 16px 20px; }
      .header-sticky { padding: 15px 20px; }
      .fab-container { left: 20px; right: 20px; }
    }

    /* Dark mode preference */
    @media (prefers-color-scheme: light) {
      :root {
        --bg-color: #f2f2f7;
        --card-bg: #ffffff;
        --input-bg: #e5e5ea;
        --text: #000000;
        --text-secondary: #8e8e93;
        --separator: #c6c6c8;
      }
    }
  </style>
</head>
<body>

<div class="header-sticky">
  <div class="header-left">
    <div class="app-logo">
      <div class="app-icon">F</div>
      <div class="app-title">FitTrack</div>
    </div>
  </div>
  
  <div class="user-selector">
    <span class="user-icon">üë§</span>
    <select id="userSelect" onchange="switchUser()"></select>
  </div>
  
  <div class="header-right">
    <button class="header-btn" onclick="openExerciseManager()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏">üèãÔ∏è</button>
    <button class="header-btn" onclick="openUserProfile()" title="–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">üìä</button>
    <button class="header-btn" id="lockBtn" onclick="toggleEditMode()" title="–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">‚úèÔ∏è</button>
  </div>
</div>

<div class="container">
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
  <div id="workoutStats" class="stats-row" style="display: none;">
    <div class="stat-item">
      <div class="stat-value" id="totalVolume">0</div>
      <div class="stat-label">–û–±—ä–µ–º (–∫–≥)</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="totalSets">0</div>
      <div class="stat-label">–ü–æ–¥—Ö–æ–¥—ã</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="bestSet">-</div>
      <div class="stat-label">–õ—É—á—à–∏–π</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="avgWeight">0</div>
      <div class="stat-label">–°—Ä. –≤–µ—Å</div>
    </div>
  </div>

  <h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
  <div class="card">
    <div class="input-row">
      <div class="select-wrapper">
        <select id="exerciseSelect" onchange="loadLastSessionHint()"></select>
      </div>
    </div>
    <div class="input-row" id="lastSessionHint" style="display:none; padding-top:8px;">
      <div id="hintText" style="font-size:13px; color:var(--primary); display: flex; justify-content: space-between; align-items: center;"></div>
    </div>
  </div>

  <h3>
    –ü–æ–¥—Ö–æ–¥—ã
    <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">
      <span id="completedSets">0</span>/<span id="totalSetsCount">0</span>
    </span>
  </h3>
  <div class="card" id="setsContainer"></div>
  
  <button class="secondary" onclick="addSet()" style="margin-bottom: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>

  <!-- –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–µ—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞) -->
  <div class="quick-weight-container">
    <button class="quick-weight-btn" onclick="quickWeight(20)">20 –∫–≥</button>
    <button class="quick-weight-btn" onclick="quickWeight(40)">40 –∫–≥</button>
    <button class="quick-weight-btn" onclick="quickWeight(60)">60 –∫–≥</button>
    <button class="quick-weight-btn" onclick="quickWeight(80)">80 –∫–≥</button>
    <button class="quick-weight-btn" onclick="quickWeight(100)">100 –∫–≥</button>
    <button class="quick-weight-btn reset" onclick="resetLastSet()">–°–±—Ä–æ—Å</button>
  </div>

  <h3>
    –ò—Å—Ç–æ—Ä–∏—è
    <div style="display: flex; gap: 8px;">
      <button class="btn-export" onclick="exportToCSV()">üì§ CSV</button>
      <button class="btn-export" onclick="clearHistory()" style="color: var(--danger);">üóëÔ∏è</button>
    </div>
  </h3>
  
  <div class="card" style="padding:16px; background: transparent; border: none;">
     <div style="margin-bottom: 12px;">
        <div class="select-wrapper">
           <select id="filterExercise" onchange="renderHistory()">
             <option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
           </select>
        </div>
     </div>
     <div class="import-export-buttons">
       <div class="file-input-wrapper">
         <button class="btn-export" onclick="triggerFileInput()" style="background: rgba(50, 215, 75, 0.1); color: var(--success);">
           üì• –ò–º–ø–æ—Ä—Ç CSV
         </button>
         <input type="file" id="csvImport" accept=".csv" class="file-input" onchange="importFromCSV(event)">
       </div>
       <button class="btn-export" onclick="showStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
       <button class="btn-export" onclick="openUsersComparison()">üë• –°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
     </div>
     <div id="historyList">
       <div class="empty-state" id="emptyHistory">
         <svg viewBox="0 0 24 24">
           <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
         </svg>
         <p>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø—É—Å—Ç–∞</p>
         <p style="font-size: 14px; margin-top: 8px;">–ù–∞—á–Ω–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!</p>
       </div>
     </div>
  </div>

  <br><br><br>
</div>

<div class="fab-container">
  <button onclick="saveWorkout()" id="saveBtn" style="box-shadow: var(--shadow); background: linear-gradient(135deg, var(--primary), #5AC8FA);">
    <span id="saveBtnText">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span>
    <span id="saveBtnLoader" class="loader" style="display: none; margin-left: 8px;"></span>
  </button>
</div>

<!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="toast" class="toast"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π -->
<div class="modal" id="exerciseModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">üèãÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeExerciseManager()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
    <input 
      type="text" 
      id="searchExercise" 
      placeholder="üîç –ü–æ–∏—Å–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π..." 
      style="margin-bottom: 15px;"
      oninput="filterExercises()"
    >
    <div style="overflow-y:auto; flex:1; margin-bottom:15px; min-height: 200px;" id="exerciseManagerList"></div>
    <div style="display:flex; gap:10px;">
      <input id="newExerciseInput" placeholder="–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" onkeypress="if(event.key === 'Enter') addExercise()">
      <button onclick="addExercise()" style="width:auto; min-width: 60px;">‚ûï</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
<div class="modal" id="usersModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeUsersManager()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
    <div style="overflow-y:auto; flex:1; margin-bottom:15px; min-height: 200px;" id="usersManagerList"></div>
    <div style="display:flex; gap:10px;">
      <input id="newUserName" placeholder="–ò–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" onkeypress="if(event.key === 'Enter') addUser()">
      <button onclick="addUser()" style="width:auto; min-width: 60px;">‚ûï</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div class="modal" id="statsModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeStats()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div style="overflow-y:auto; flex:1; padding: 10px;" id="statsContent">
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal" id="profileModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeUserProfile()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('profile-tab')">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button class="tab" onclick="switchTab('history-tab')">–ò—Å—Ç–æ—Ä–∏—è</button>
      <button class="tab" onclick="switchTab('chart-tab')">–ì—Ä–∞—Ñ–∏–∫</button>
    </div>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profile-tab" class="tab-content active">
      <div class="profile-stats">
        <div class="profile-stat">
          <div class="profile-stat-value" id="profileHeight">- —Å–º</div>
          <div class="profile-stat-label">–†–æ—Å—Ç</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profileWeight">- –∫–≥</div>
          <div class="profile-stat-label">–í–µ—Å</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profileIMC">-</div>
          <div class="profile-stat-label">–ò–ú–¢</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profileWorkouts">0</div>
          <div class="profile-stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        </div>
      </div>
      
      <h3 style="margin: 20px 0 10px 0;">üìù –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
      <div class="profile-input-group">
        <input type="number" id="editHeight" placeholder="–†–æ—Å—Ç (—Å–º)" min="100" max="250">
        <input type="number" id="editWeight" placeholder="–í–µ—Å (–∫–≥)" min="30" max="200" step="0.1">
      </div>
      <button onclick="saveUserParameters()" style="width:100%; margin-bottom: 15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      
      <div style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 10px;">
        <div>–ò–ú–¢ = –≤–µ—Å (–∫–≥) / (—Ä–æ—Å—Ç (–º))¬≤</div>
        <div style="margin-top: 5px;">
          <span style="color: var(--success);">18.5-24.9</span> - –Ω–æ—Ä–º–∞,
          <span style="color: var(--warning);">25-29.9</span> - –∏–∑–±—ã—Ç–æ–∫,
          <span style="color: var(--danger);">‚â•30</span> - –æ–∂–∏—Ä–µ–Ω–∏–µ
        </div>
      </div>
    </div>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="history-tab" class="tab-content">
      <div id="parametersHistory" style="overflow-y: auto; max-height: 300px;">
        <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
    </div>
    
    <!-- –í–∫–ª–∞–¥–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ -->
    <div id="chart-tab" class="tab-content">
      <div class="chart-container">
        <canvas id="parametersChart"></canvas>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="secondary" style="flex:1; font-size: 12px;" onclick="chartPeriod = 7; renderParametersChart()">–ù–µ–¥–µ–ª—è</button>
        <button class="secondary" style="flex:1; font-size: 12px;" onclick="chartPeriod = 30; renderParametersChart()">–ú–µ—Å—è—Ü</button>
        <button class="secondary" style="flex:1; font-size: 12px;" onclick="chartPeriod = 90; renderParametersChart()">3 –º–µ—Å—è—Ü–∞</button>
        <button class="secondary" style="flex:1; font-size: 12px;" onclick="chartPeriod = 365; renderParametersChart()">–ì–æ–¥</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div class="modal" id="comparisonModal">
  <div class="modal-card">
    <div class="modal-handle"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items: center;">
      <h2 style="margin:0; font-size:20px;">üë• –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
      <button class="secondary" style="width:auto; padding:6px 12px;" onclick="closeUsersComparison()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div style="margin-bottom: 15px;">
      <div class="select-wrapper">
        <select id="comparisonExercise" onchange="renderUsersComparison()">
          <option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>
        </select>
      </div>
    </div>
    
    <div style="overflow-y:auto; flex:1; min-height: 300px;" id="comparisonContent">
      <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>
</div>

<script>
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
const STORAGE_KEY_PREFIX = 'fitness_data_v8';
const EXERCISE_KEY_PREFIX = 'fitness_exercises_v8';
const USERS_KEY = 'fitness_users_v5';
const CURRENT_USER_KEY = 'fitness_current_user_v5';
const USER_PARAMS_KEY = 'fitness_user_params_v1';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã/–æ–±—ä–µ–∫—Ç—ã
let appData = [];
let exercises = [];
let currentSets = [];
let users = [];
let userParameters = {};
let currentUser = null;
let editMode = false;
let editingId = null;
let originalSetsBackup = null;
let chartPeriod = 30;
let parametersChart = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = () => {
  // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
  appData = [];
  exercises = [];
  currentSets = [];
  users = [];
  userParameters = {};
  
  // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  loadUsers();
  loadCurrentUser();
  loadUserParameters();
  loadData();
  renderExercises();
  renderHistory();
  addSet();
  updateStats();
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ sessionStorage
  const savedSets = sessionStorage.getItem(`currentSets_${currentUser?.id}`);
  if (savedSets) {
    try {
      currentSets = JSON.parse(savedSets);
      if (!Array.isArray(currentSets)) currentSets = [];
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ savedSets:', e);
      currentSets = [];
    }
    renderSets();
  }
  
  // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', autoSaveCurrentSets);
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) autoSaveCurrentSets();
  });
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  setTimeout(() => {
    if (!initDOMCheck()) {
      console.error('–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞', 'error');
    }
  }, 100);
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadUsers() {
  try {
    const storedUsers = localStorage.getItem(USERS_KEY);
    if (storedUsers) {
      const parsed = JSON.parse(storedUsers);
      users = Array.isArray(parsed) ? parsed : [];
    } else {
      users = [];
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (users.length === 0) {
      users = [
        { id: 'user_ivan', name: '–ò–≤–∞–Ω', createdAt: Date.now() },
        { id: 'user_andrey', name: '–ê–Ω–¥—Ä–µ–π', createdAt: Date.now() + 1 }
      ];
      saveUsers();
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
    users = [
      { id: 'user_ivan', name: '–ò–≤–∞–Ω', createdAt: Date.now() },
      { id: 'user_andrey', name: '–ê–Ω–¥—Ä–µ–π', createdAt: Date.now() + 1 }
    ];
  }
}

function loadCurrentUser() {
  try {
    const storedCurrentUser = localStorage.getItem(CURRENT_USER_KEY);
    if (storedCurrentUser) {
      currentUser = JSON.parse(storedCurrentUser);
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
      const userExists = users.some(u => u.id === currentUser.id);
      if (!userExists) {
        currentUser = users[0];
        saveCurrentUser();
      }
    } else {
      currentUser = users[0];
      saveCurrentUser();
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
    currentUser = users[0];
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  renderUserSelector();
}

function loadUserParameters() {
  try {
    const storedParams = localStorage.getItem(USER_PARAMS_KEY);
    if (storedParams) {
      const parsed = JSON.parse(storedParams);
      userParameters = typeof parsed === 'object' ? parsed : {};
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É –∫–æ—Ç–æ—Ä—ã—Ö –∏—Ö –Ω–µ—Ç
      users.forEach(user => {
        if (!userParameters[user.id]) {
          userParameters[user.id] = {
            height: null,
            weight: null,
            history: []
          };
        }
      });
    } else {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      userParameters = {};
      users.forEach(user => {
        userParameters[user.id] = {
          height: null,
          weight: null,
          history: []
        };
      });
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      saveUserParametersToStorage();
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
    userParameters = {};
  }
}

function saveUsers() {
  try {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
  }
}

function saveCurrentUser() {
  try {
    localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
  }
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ localStorage
function saveUserParametersToStorage() {
  try {
    localStorage.setItem(USER_PARAMS_KEY, JSON.stringify(userParameters));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
  }
}

function renderUserSelector() {
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const oldValue = select.value;
  
  select.innerHTML = '';
  
  users.forEach(user => {
    const option = document.createElement('option');
    option.value = user.id;
    option.textContent = user.name;
    option.selected = user.id === currentUser.id;
    select.appendChild(option);
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  const manageOption = document.createElement('option');
  manageOption.value = 'manage';
  manageOption.textContent = '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
  select.appendChild(manageOption);
  
  if (oldValue && users.some(u => u.id === oldValue)) {
    select.value = oldValue;
  }
}

function switchUser() {
  const select = document.getElementById('userSelect');
  if (!select) return;
  
  const selectedValue = select.value;
  
  if (selectedValue === 'manage') {
    openUsersManager();
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä–µ
    setTimeout(() => {
      select.value = currentUser.id;
    }, 100);
    return;
  }
  
  const newUser = users.find(u => u.id === selectedValue);
  if (newUser && newUser.id !== currentUser.id) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–¥—Ö–æ–¥—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
    autoSaveCurrentSets();
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    currentUser = newUser;
    saveCurrentUser();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadData();
    renderExercises();
    renderHistory();
    updateStats();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedSets = sessionStorage.getItem(`currentSets_${currentUser.id}`);
    if (savedSets) {
      try {
        currentSets = JSON.parse(savedSets);
        if (!Array.isArray(currentSets)) currentSets = [];
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ savedSets:', e);
        currentSets = [];
      }
    } else {
      currentSets = [];
      addSet();
    }
    
    renderSets();
    
    showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.name}`, 'success');
  }
}

function openUsersManager() {
  renderUsersManagerList();
  document.getElementById('usersModal').classList.add('active');
  document.getElementById('newUserName').focus();
}

function closeUsersManager() {
  document.getElementById('usersModal').classList.remove('active');
  renderUserSelector();
}

function renderUsersManagerList() {
  const container = document.getElementById('usersManagerList');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (users.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px;">
        <p>–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
      </div>
    `;
    return;
  }
  
  users.forEach((user, index) => {
    const userElement = document.createElement('div');
    userElement.className = 'input-row';
    userElement.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 4px;
    `;
    
    const isCurrent = user.id === currentUser.id;
    const params = userParameters[user.id] || { height: null, weight: null };
    const bmi = params.height && params.weight ? 
      (params.weight / ((params.height/100) * (params.height/100))).toFixed(1) : '-';
    
    userElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
        <span style="color: var(--text-secondary); font-size: 12px; width: 24px;">${index + 1}.</span>
        <div style="flex: 1;">
          <div style="font-weight: ${isCurrent ? '600' : '400'}; color: ${isCurrent ? 'var(--primary)' : 'var(--text)'};">${user.name}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">
            ${params.height ? params.height + ' —Å–º' : '–†–æ—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢ 
            ${params.weight ? params.weight + ' –∫–≥' : '–í–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢ 
            –ò–ú–¢: ${bmi}
          </div>
        </div>
        ${isCurrent ? '<span style="font-size: 10px; color: var(--success); background: rgba(50, 215, 75, 0.1); padding: 2px 6px; border-radius: 10px;">—Ç–µ–∫—É—â–∏–π</span>' : ''}
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="header-btn" onclick="renameUser('${user.id}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" style="width: 32px; height: 32px; font-size: 12px;">‚úèÔ∏è</button>
        ${user.id !== 'user_ivan' ? `<button class="header-btn" onclick="removeUser('${user.id}')" title="–£–¥–∞–ª–∏—Ç—å" style="width: 32px; height: 32px; color: var(--danger);">üóëÔ∏è</button>` : ''}
      </div>
    `;
    
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    userElement.ondblclick = () => {
      if (user.id !== currentUser.id) {
        switchToUser(user.id);
      }
      closeUsersManager();
    };
    
    container.appendChild(userElement);
  });
}

function addUser() {
  const input = document.getElementById('newUserName');
  if (!input) return;
  
  const value = input.value.trim();
  
  if (!value) {
    showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
    input.focus();
    return;
  }
  
  if (users.some(u => u.name.toLowerCase() === value.toLowerCase())) {
    showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
    input.focus();
    return;
  }
  
  const newUser = {
    id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    name: value,
    createdAt: Date.now()
  };
  
  users.push(newUser);
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  userParameters[newUser.id] = {
    height: null,
    weight: null,
    history: []
  };
  
  saveUsers();
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  saveUserParametersToStorage();
  renderUsersManagerList();
  input.value = '';
  input.focus();
  
  showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${value}" –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
}

function renameUser(userId) {
  const user = users.find(u => u.id === userId);
  if (!user) return;
  
  const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.name);
  
  if (newName && newName.trim() && newName.trim() !== user.name) {
    if (users.some(u => u.id !== userId && u.name.toLowerCase() === newName.trim().toLowerCase())) {
      showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
      return;
    }
    
    const oldName = user.name;
    user.name = newName.trim();
    
    saveUsers();
    renderUsersManagerList();
    renderUserSelector();
    
    if (userId === currentUser.id) {
      currentUser = user;
      saveCurrentUser();
    }
    
    showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: "${oldName}" ‚Üí "${newName.trim()}"`, 'success');
  }
}

function removeUser(userId) {
  if (userId === 'user_ivan') {
    showToast('–û—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å', 'warning');
    return;
  }
  
  const user = users.find(u => u.id === userId);
  if (!user) return;
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${user.name}"?\n–í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`)) {
    return;
  }
  
  // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
  if (userId === currentUser.id) {
    currentUser = users.find(u => u.id === 'user_ivan');
    saveCurrentUser();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadData();
    renderExercises();
    renderHistory();
    updateStats();
    
    currentSets = [];
    addSet();
    renderSets();
    
    // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
    sessionStorage.removeItem(`currentSets_${userId}`);
  }
  
  // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
  localStorage.removeItem(`${STORAGE_KEY_PREFIX}_${userId}`);
  localStorage.removeItem(`${EXERCISE_KEY_PREFIX}_${userId}`);
  
  // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (userParameters[userId]) {
    delete userParameters[userId];
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    saveUserParametersToStorage();
  }
  
  // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
  users = users.filter(u => u.id !== userId);
  saveUsers();
  renderUsersManagerList();
  renderUserSelector();
  
  showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${user.name}" —É–¥–∞–ª–µ–Ω`, 'warning');
}

function switchToUser(userId) {
  const user = users.find(u => u.id === userId);
  if (user && user.id !== currentUser.id) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–¥—Ö–æ–¥—ã
    autoSaveCurrentSets();
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º
    currentUser = user;
    saveCurrentUser();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadData();
    renderExercises();
    renderHistory();
    updateStats();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
    const savedSets = sessionStorage.getItem(`currentSets_${currentUser.id}`);
    if (savedSets) {
      try {
        currentSets = JSON.parse(savedSets);
        if (!Array.isArray(currentSets)) currentSets = [];
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ savedSets:', e);
        currentSets = [];
      }
    } else {
      currentSets = [];
      addSet();
    }
    
    renderSets();
    renderUserSelector();
    
    showToast(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${currentUser.name}`, 'success');
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function loadData() {
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º appData
    const storageKey = `${STORAGE_KEY_PREFIX}_${currentUser.id}`;
    const storedAppData = localStorage.getItem(storageKey);
    if (storedAppData) {
      const parsed = JSON.parse(storedAppData);
      appData = Array.isArray(parsed) ? parsed : [];
    } else {
      appData = [];
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º exercises
    const exerciseKey = `${EXERCISE_KEY_PREFIX}_${currentUser.id}`;
    const storedExercises = localStorage.getItem(exerciseKey);
    if (storedExercises) {
      const parsed = JSON.parse(storedExercises);
      exercises = Array.isArray(parsed) ? parsed : [];
    } else {
      exercises = [];
    }
    
    // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
    if (!exercises.length) {
      exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
      saveExercises();
    }
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    appData = [];
    exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function saveData() {
  try {
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ appData - —ç—Ç–æ –º–∞—Å—Å–∏–≤
    if (!Array.isArray(appData)) {
      console.warn('appData –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
      appData = [];
    }
    
    const storageKey = `${STORAGE_KEY_PREFIX}_${currentUser.id}`;
    localStorage.setItem(storageKey, JSON.stringify(appData));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
}

function saveExercises() {
  try {
    const exerciseKey = `${EXERCISE_KEY_PREFIX}_${currentUser.id}`;
    localStorage.setItem(exerciseKey, JSON.stringify(exercises));
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', e);
  }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ —Å —É—á–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function autoSaveCurrentSets() {
  if (currentSets.some(set => set.weight || set.reps)) {
    sessionStorage.setItem(`currentSets_${currentUser.id}`, JSON.stringify(currentSets));
  }
}

// –†–∞–±–æ—Ç–∞ —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏
function addSet() {
  const lastSet = currentSets.length > 0 
    ? currentSets[currentSets.length - 1] 
    : { reps: '', weight: '' };
    
  currentSets.push({ 
    id: Date.now() + Math.random(), 
    reps: lastSet.reps, 
    weight: lastSet.weight 
  });
  
  renderSets();
  updateStats();
}

function removeSet(idx) {
  if (currentSets.length > 1) {
    currentSets.splice(idx, 1);
  } else {
    currentSets[0] = { reps: '', weight: '' };
  }
  
  renderSets();
  updateStats();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–≤–æ–¥–∞ - —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞
function validateNumberInput(value) {
  // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä –∏ —Ç–æ—á–∫–∏
  let cleaned = value.replace(/[^\d.]/g, '');
  
  // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —Ç–æ—á–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é)
  const parts = cleaned.split('.');
  if (parts.length > 2) {
    cleaned = parts[0] + '.' + parts.slice(1).join('');
  }
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å –¥–æ 1 –∑–Ω–∞–∫–∞
  if (cleaned.includes('.')) {
    const [integer, decimal] = cleaned.split('.');
    if (decimal.length > 1) {
      cleaned = integer + '.' + decimal.substring(0, 1);
    }
  }
  
  return cleaned;
}

function updateSet(idx, field, value) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ - —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞
  if (field === 'weight' || field === 'reps') {
    // –û—á–∏—â–∞–µ–º –≤–≤–æ–¥
    value = validateNumberInput(value);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const numValue = parseFloat(value);
    if (field === 'weight' && numValue > 1000) value = '1000';
    if (field === 'reps' && numValue > 200) value = '200';
    
    // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º –≤–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫—É
    if (value === '.') value = '0.';
  }
  
  if (currentSets[idx]) {
    currentSets[idx][field] = value;
  }
  
  updateStats();
}

function renderSets() {
  const container = document.getElementById('setsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (currentSets.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 30px 20px;">
        <svg viewBox="0 0 24 24">
          <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
        </svg>
        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥—Ö–æ–¥—ã</p>
      </div>
    `;
    return;
  }
  
  currentSets.forEach((set, i) => {
    const row = document.createElement('div');
    row.className = 'set-row';
    row.innerHTML = `
      <span class="set-index">${i + 1}</span>
      <div class="set-inputs">
        <input 
          type="text" 
          inputmode="decimal"
          placeholder="–∫–≥" 
          value="${set.weight || ''}" 
          oninput="updateSet(${i},'weight',this.value)"
          pattern="[0-9]*[.]?[0-9]*"
        >
        <input 
          type="text" 
          inputmode="numeric"
          placeholder="–ø–æ–≤—Ç" 
          value="${set.reps || ''}" 
          oninput="updateSet(${i},'reps',this.value)"
          pattern="[0-9]*"
        >
      </div>
      <button class="btn-delete" onclick="removeSet(${i})" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥—Ö–æ–¥">
        <svg viewBox="0 0 24 24">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    `;
    container.appendChild(row);
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ–¥—Ö–æ–¥–æ–≤
  const completedSets = currentSets.filter(s => s.reps && s.weight).length;
  const completedSetsEl = document.getElementById('completedSets');
  const totalSetsCountEl = document.getElementById('totalSetsCount');
  
  if (completedSetsEl) completedSetsEl.textContent = completedSets;
  if (totalSetsCountEl) totalSetsCountEl.textContent = currentSets.length;
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function updateStats() {
  const validSets = currentSets.filter(s => s.reps && s.weight);
  const statsContainer = document.getElementById('workoutStats');
  
  if (!statsContainer) return;
  
  if (validSets.length === 0) {
    statsContainer.style.display = 'none';
    return;
  }
  
  statsContainer.style.display = 'flex';
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const totalVolume = validSets.reduce((sum, set) => {
    const weight = parseFloat(set.weight) || 0;
    const reps = parseInt(set.reps) || 0;
    return sum + (weight * reps);
  }, 0);
  
  const totalWeight = validSets.reduce((sum, set) => {
    return sum + (parseFloat(set.weight) || 0);
  }, 0);
  
  const bestSet = validSets.reduce((best, set) => {
    const weight = parseFloat(set.weight) || 0;
    const reps = parseInt(set.reps) || 0;
    const current = weight * reps;
    return current > best.value ? { set, value: current } : best;
  }, { set: null, value: 0 });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º UI
  const totalVolumeEl = document.getElementById('totalVolume');
  const totalSetsEl = document.getElementById('totalSets');
  const bestSetEl = document.getElementById('bestSet');
  const avgWeightEl = document.getElementById('avgWeight');
  
  if (totalVolumeEl) totalVolumeEl.textContent = Math.round(totalVolume);
  if (totalSetsEl) totalSetsEl.textContent = validSets.length;
  if (bestSetEl) bestSetEl.textContent = bestSet.set 
    ? `${bestSet.set.weight}√ó${bestSet.set.reps}`
    : '-';
  if (avgWeightEl) avgWeightEl.textContent = 
    validSets.length > 0 ? Math.round(totalWeight / validSets.length) : 0;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
async function saveWorkout() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ saveWorkout, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
  }
  
  const name = document.getElementById('exerciseSelect').value;
  const validSets = currentSets.filter(s => s.reps && s.weight);
  
  if (!name || name === '–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...') {
    showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', 'error');
    return;
  }
  
  if (!validSets.length) {
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥', 'error');
    return;
  }
  
  // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
  if (navigator.vibrate) navigator.vibrate(50);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  const saveBtn = document.getElementById('saveBtn');
  const saveBtnText = document.getElementById('saveBtnText');
  const saveBtnLoader = document.getElementById('saveBtnLoader');
  
  if (!saveBtn || !saveBtnText || !saveBtnLoader) {
    showToast('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞', 'error');
    return;
  }
  
  saveBtn.disabled = true;
  saveBtnText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
  saveBtnLoader.style.display = 'inline-block';
  
  // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è UX
  await new Promise(resolve => setTimeout(resolve, 500));
  
  const record = {
    id: editingId || Date.now() + '-' + Math.random().toString(36).substr(2, 9),
    name,
    sets: JSON.parse(JSON.stringify(validSets)),
    date: editingId ? (appData.find(x => x.id === editingId)?.date || Date.now()) : Date.now(),
    volume: validSets.reduce((sum, set) => {
      const weight = parseFloat(set.weight) || 0;
      const reps = parseInt(set.reps) || 0;
      return sum + (weight * reps);
    }, 0),
    userId: currentUser.id
  };
  
  if (editingId) {
    const index = appData.findIndex(x => x.id === editingId);
    if (index !== -1) {
      appData[index] = record;
    } else {
      // –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –Ω–æ–≤—É—é
      appData.push(record);
    }
    editingId = null;
    originalSetsBackup = null;
    saveBtnText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
  } else {
    appData.push(record);
  }
  
  saveData();
  currentSets = [];
  addSet(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  sessionStorage.removeItem(`currentSets_${currentUser.id}`);
  renderSets();
  renderHistory();
  updateStats();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  saveBtn.disabled = false;
  saveBtnText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
  saveBtnLoader.style.display = 'none';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  showToast('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
  
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∏—Å—Ç–æ—Ä–∏–∏
  const historyList = document.querySelector('#historyList');
  if (historyList) {
    window.scrollTo({
      top: historyList.offsetTop - 100,
      behavior: 'smooth'
    });
  }
}

// –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
function renderHistory() {
  const container = document.getElementById('historyList');
  const emptyState = document.getElementById('emptyHistory');
  const filterSelect = document.getElementById('filterExercise');
  
  if (!container) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
  const filter = filterSelect ? filterSelect.value : '';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ renderHistory, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
  }
  
  if (!appData.length) {
    if (emptyState) emptyState.style.display = 'block';
    container.innerHTML = '';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  container.innerHTML = '';
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
  let filteredData = appData;
  if (filter) {
    filteredData = appData.filter(item => item.name === filter);
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  const sortedData = [...filteredData].sort((a, b) => {
    const dateA = a.date || 0;
    const dateB = b.date || 0;
    return dateB - dateA;
  });
  
  if (sortedData.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <p>–ù–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</p>
      </div>
    `;
    return;
  }
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º
  const grouped = sortedData.reduce((groups, item) => {
    const date = new Date(item.date).toLocaleDateString('ru-RU', {
      weekday: 'long',
      day: 'numeric',
      month: 'long'
    });
    
    if (!groups[date]) groups[date] = [];
    groups[date].push(item);
    return groups;
  }, {});
  
  // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä—É–ø–ø
  Object.entries(grouped).forEach(([date, items]) => {
    const groupElement = document.createElement('div');
    groupElement.className = 'history-group';
    
    groupElement.innerHTML = `
      <div class="history-date">
        ${date}
        <span style="font-size: 12px; color: var(--text-secondary); font-weight: normal;">
          (${items.length} ${getPluralForm(items.length, ['—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫'])})
        </span>
      </div>
    `;
    
    items.forEach(item => {
      if (!item.sets || !Array.isArray(item.sets)) {
        console.warn('–£ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç sets –∏–ª–∏ —ç—Ç–æ –Ω–µ –º–∞—Å—Å–∏–≤:', item);
        return;
      }
      
      const itemElement = document.createElement('div');
      itemElement.className = 'history-item';
      
      const totalVolume = item.sets.reduce((sum, set) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        return sum + (weight * reps);
      }, 0);
      
      const setsHtml = item.sets.map((set, index) => `
        <span class="tag" title="–ü–æ–¥—Ö–æ–¥ ${index + 1}">
          ${set.weight || 0}–∫–≥ √ó ${set.reps || 0}
        </span>
      `).join('');
      
      const actions = editMode ? `
        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
          <button class="secondary" 
            style="width: auto; padding: 6px 12px; font-size: 13px;" 
            onclick="editRec('${item.id}')"
            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
          </button>
          <button class="secondary" 
            style="width: auto; padding: 6px 12px; font-size: 13px; color: var(--danger);" 
            onclick="delRec('${item.id}')"
            title="–£–¥–∞–ª–∏—Ç—å">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      ` : '';
      
      itemElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start;">
          <div>
            <b style="font-size: 16px;">${item.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</b>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
              ${new Date(item.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
              ‚Ä¢ ${item.sets.length} ${getPluralForm(item.sets.length, ['–ø–æ–¥—Ö–æ–¥', '–ø–æ–¥—Ö–æ–¥–∞', '–ø–æ–¥—Ö–æ–¥–æ–≤'])}
              ‚Ä¢ ${Math.round(totalVolume)} –∫–≥ –æ–±—â–∏–π –æ–±—ä–µ–º
            </div>
          </div>
          <div style="font-size: 14px; color: var(--primary); font-weight: 600;">
            ${Math.round(totalVolume)} –∫–≥
          </div>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
          ${setsHtml}
        </div>
        ${actions}
      `;
      
      groupElement.appendChild(itemElement);
    });
    
    container.appendChild(groupElement);
  });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è
function getPluralForm(n, forms) {
  n = Math.abs(n) % 100;
  const n1 = n % 10;
  if (n > 10 && n < 20) return forms[2];
  if (n1 > 1 && n1 < 5) return forms[1];
  if (n1 === 1) return forms[0];
  return forms[2];
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function editRec(id) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ editRec, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    return;
  }
  
  const record = appData.find(x => x.id === id);
  if (!record) {
    showToast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
    return;
  }
  
  document.getElementById('exerciseSelect').value = record.name;
  currentSets = JSON.parse(JSON.stringify(record.sets || []));
  editingId = id;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã
  originalSetsBackup = JSON.parse(JSON.stringify(record.sets || []));
  
  const saveBtn = document.querySelector('.fab-container button');
  if (saveBtn) {
    saveBtn.innerHTML = '<span id="saveBtnText">‚úèÔ∏è –û–±–Ω–æ–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span><span id="saveBtnLoader" class="loader" style="display: none; margin-left: 8px;"></span>';
  }
  
  renderSets();
  updateStats();
  
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –≤–µ—Ä—Ö—É
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  
  showToast('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', 'warning');
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
function delRec(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ delRec, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    renderHistory();
    return;
  }
  
  appData = appData.filter(x => x.id !== id);
  saveData();
  renderHistory();
  showToast('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'error');
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
function clearHistory() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
    return;
  }
  
  appData = [];
  saveData();
  renderHistory();
  showToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞', 'error');
}

// –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - —Å –æ—Ç–º–µ–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
function toggleEditMode() {
  if (editMode && editingId && originalSetsBackup) {
    // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–¥—Ö–æ–¥—ã –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥
      currentSets = [{ id: Date.now() + Math.random(), reps: '', weight: '' }];
      editingId = null;
      originalSetsBackup = null;
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const saveBtn = document.querySelector('.fab-container button');
      if (saveBtn) {
        saveBtn.innerHTML = '<span id="saveBtnText">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</span><span id="saveBtnLoader" class="loader" style="display: none; margin-left: 8px;"></span>';
      }
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
      document.getElementById('exerciseSelect').value = '–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...';
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
      const hint = document.getElementById('lastSessionHint');
      if (hint) {
        hint.style.display = 'none';
      }
      
      renderSets();
      updateStats();
      showToast('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'warning');
      
      // –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã
      editMode = false;
      const lockBtn = document.getElementById('lockBtn');
      if (lockBtn) {
        lockBtn.classList.remove('active');
        lockBtn.title = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω';
      }
      
      renderHistory();
      return; // –ù–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º editMode –≤ –∫–æ–Ω—Ü–µ —Ñ—É–Ω–∫—Ü–∏–∏
    } else {
      return; // –ù–µ –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    }
  }
  
  editMode = !editMode;
  const lockBtn = document.getElementById('lockBtn');
  
  if (!lockBtn) return;
  
  if (editMode) {
    lockBtn.classList.add('active');
    lockBtn.title = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω';
    showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω', 'warning');
  } else {
    lockBtn.classList.remove('active');
    lockBtn.title = '–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω';
    showToast('–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω', 'success');
  }
  
  renderHistory();
}

// –ü–æ–¥—Å–∫–∞–∑–∫–∞ –æ –ø—Ä–æ—à–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
function loadLastSessionHint() {
  const name = document.getElementById('exerciseSelect').value;
  const hint = document.getElementById('lastSessionHint');
  
  if (!name || name === '–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...' || !hint) {
    if (hint) hint.style.display = 'none';
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ appData - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(appData)) {
    console.warn('appData –Ω–µ –º–∞—Å—Å–∏–≤ –≤ loadLastSessionHint, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    appData = [];
    hint.style.display = 'none';
    return;
  }
  
  const lastSessions = appData
    .filter(x => x.name === name)
    .sort((a, b) => b.date - a.date);
  
  if (lastSessions.length > 0) {
    const last = lastSessions[0];
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É last –µ—Å—Ç—å sets
    if (!last.sets || !Array.isArray(last.sets) || last.sets.length === 0) {
      hint.style.display = 'none';
      return;
    }
    
    const bestSet = last.sets.reduce((max, set) => {
      const weight = parseFloat(set.weight) || 0;
      const reps = parseInt(set.reps) || 0;
      const current = weight * reps;
      return current > max.value ? { set, value: current } : max;
    }, { set: null, value: 0 });
    
    if (bestSet.set) {
      const totalVolume = last.sets.reduce((sum, set) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        return sum + (weight * reps);
      }, 0);
      
      const daysAgo = Math.floor((Date.now() - last.date) / (1000 * 60 * 60 * 24));
      const daysText = daysAgo === 0 ? '—Å–µ–≥–æ–¥–Ω—è' : 
                      daysAgo === 1 ? '–≤—á–µ—Ä–∞' : 
                      `${daysAgo} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
      
      const hintText = document.getElementById('hintText');
      if (hintText) {
        hintText.innerHTML = `
          <span>
            <strong>${daysText}:</strong> ${bestSet.set.weight}–∫–≥ √ó ${bestSet.set.reps} (–ª—É—á—à–∏–π)
          </span>
          <span style="color: var(--text-secondary); font-size: 12px;">
            ${last.sets.length} –ø–æ–¥—Ö–æ–¥–∞ ‚Ä¢ ${Math.round(totalVolume)}–∫–≥
          </span>
        `;
      }
      
      hint.style.display = 'block';
    } else {
      hint.style.display = 'none';
    }
  } else {
    hint.style.display = 'none';
  }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏
function renderExercises() {
  const select = document.getElementById('exerciseSelect');
  const filter = document.getElementById('filterExercise');
  const comparisonExercise = document.getElementById('comparisonExercise');
  
  if (!select || !filter) return;
  
  const oldSelectValue = select.value;
  const oldFilterValue = filter.value;
  
  // –û—á–∏—â–∞–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  select.innerHTML = '<option disabled selected>–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...</option>';
  filter.innerHTML = '<option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>';
  if (comparisonExercise) {
    comparisonExercise.innerHTML = '<option value="">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</option>';
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ exercises - –º–∞—Å—Å–∏–≤
  if (!Array.isArray(exercises)) {
    console.warn('exercises –Ω–µ –º–∞—Å—Å–∏–≤, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
    exercises = ['–ñ–∏–º –ª–µ–∂–∞', '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', '–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', '–ñ–∏–º —Å—Ç–æ—è', '–¢—è–≥–∞ –±–ª–æ–∫–∞'];
    saveExercises();
  }
  
  [...exercises].sort().forEach(exercise => {
    select.add(new Option(exercise, exercise));
    filter.add(new Option(exercise, exercise));
    if (comparisonExercise) {
      comparisonExercise.add(new Option(exercise, exercise));
    }
  });
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
  if (exercises.includes(oldSelectValue)) select.value = oldSelectValue;
  if (exercises.includes(oldFilterValue)) filter.value = oldFilterValue;
}

function openExerciseManager() {
  renderExerciseManagerList();
  document.getElementById('exerciseModal').classList.add('active');
  document.getElementById('newExerciseInput').focus();
}

function closeExerciseManager() {
  document.getElementById('exerciseModal').classList.remove('active');
  renderExercises();
}

function renderExerciseManagerList() {
  const container = document.getElementById('exerciseManagerList');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (exercises.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px;">
        <p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
      </div>
    `;
    return;
  }
  
  [...exercises].sort().forEach((exercise, index) => {
    const exerciseElement = document.createElement('div');
    exerciseElement.className = 'input-row';
    exerciseElement.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 4px;
    `;
    
    exerciseElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
        <span style="color: var(--text-secondary); font-size: 12px; width: 24px;">${index + 1}.</span>
        <span style="flex: 1;">${exercise}</span>
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="header-btn" onclick="renameExercise(${index})" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" style="width: 32px; height: 32px; font-size: 12px;">‚úèÔ∏è</button>
        <button class="header-btn" onclick="removeExercise(${index})" title="–£–¥–∞–ª–∏—Ç—å" style="width: 32px; height: 32px; color: var(--danger);">üóëÔ∏è</button>
      </div>
    `;
    
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
    exerciseElement.ondblclick = () => {
      const select = document.getElementById('exerciseSelect');
      if (select) {
        select.value = exercise;
        closeExerciseManager();
        loadLastSessionHint();
      }
    };
    
    container.appendChild(exerciseElement);
  });
}

function filterExercises() {
  const searchTerm = document.getElementById('searchExercise').value.toLowerCase();
  const container = document.getElementById('exerciseManagerList');
  if (!container) return;
  
  const items = container.getElementsByClassName('input-row');
  
  Array.from(items).forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
  });
}

function addExercise() {
  const input = document.getElementById('newExerciseInput');
  if (!input) return;
  
  const value = input.value.trim();
  
  if (!value) {
    showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', 'error');
    input.focus();
    return;
  }
  
  if (exercises.includes(value)) {
    showToast('–≠—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'warning');
    input.focus();
    return;
  }
  
  exercises.push(value);
  saveExercises();
  renderExerciseManagerList();
  input.value = '';
  input.focus();
  
  showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${value}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');
}

function removeExercise(index) {
  const exerciseName = exercises[index];
  
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exerciseName}"?\n–í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.`)) {
    return;
  }
  
  exercises.splice(index, 1);
  saveExercises();
  renderExerciseManagerList();
  
  showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exerciseName}" —É–¥–∞–ª–µ–Ω–æ`, 'warning');
}

function renameExercise(index) {
  const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', exercises[index]);
  
  if (newName && newName.trim() && newName.trim() !== exercises[index]) {
    if (exercises.includes(newName.trim())) {
      showToast('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
      return;
    }
    
    const oldName = exercises[index];
    exercises[index] = newName.trim();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å —ç—Ç–∏–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
    appData.forEach(record => {
      if (record.name === oldName) {
        record.name = newName.trim();
      }
    });
    
    saveExercises();
    saveData();
    renderExerciseManagerList();
    renderExercises();
    
    showToast(`–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: "${oldName}" ‚Üí "${newName.trim()}"`, 'success');
  }
}

// –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–µ—Å–∞ - –¢–û–õ–¨–ö–û –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
function quickWeight(weight) {
  if (currentSets.length === 0) {
    showToast('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–¥—Ö–æ–¥', 'warning');
    return;
  }
  
  const lastIndex = currentSets.length - 1;
  currentSets[lastIndex].weight = weight;
  
  renderSets();
  updateStats();
  showToast(`–í–µ—Å ${weight}–∫–≥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞`, 'success');
}

// –°–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
function resetLastSet() {
  if (currentSets.length === 0) {
    showToast('–ù–µ—Ç –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–ª—è —Å–±—Ä–æ—Å–∞', 'warning');
    return;
  }
  
  const lastIndex = currentSets.length - 1;
  currentSets[lastIndex].weight = '';
  currentSets[lastIndex].reps = '';
  
  renderSets();
  updateStats();
  showToast('–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ö–æ–¥ —Å–±—Ä–æ—à–µ–Ω', 'warning');
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
function exportToCSV() {
  if (!appData.length) {
    showToast('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞', 'warning');
    return;
  }
  
  try {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
    csvContent += "–î–∞—Ç–∞;–í—Ä–µ–º—è;–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ;–ü–æ–¥—Ö–æ–¥;–í–µ—Å (–∫–≥);–ü–æ–≤—Ç–æ—Ä—ã;–û–±—ä–µ–º\n";
    
    const sortedData = [...appData].sort((a, b) => a.date - b.date);
    
    sortedData.forEach(workout => {
      const date = new Date(workout.date);
      const dateStr = date.toLocaleDateString('ru-RU');
      const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      
      workout.sets.forEach((set, index) => {
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        const volume = weight * reps;
        csvContent += `${dateStr};${timeStr};"${workout.name}";${index + 1};"${weight}";"${reps}";"${volume}"\n`;
      });
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `fitness_${currentUser.name}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('–≠–∫—Å–ø–æ—Ä—Ç CSV –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ', 'error');
  }
}

// –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
function triggerFileInput() {
  document.getElementById('csvImport').click();
}

// –ò–º–ø–æ—Ä—Ç –∏–∑ CSV - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
function importFromCSV(event) {
  const file = event.target.files[0];
  if (!file) {
    showToast('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', 'warning');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'error');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const content = e.target.result;
      const lines = content.split('\n');
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      let importedCount = 0;
      let skippedCount = 0;
      let errors = [];
      
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
      const newWorkouts = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        try {
          // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É CSV —Å —É—á–µ—Ç–æ–º –∫–∞–≤—ã—á–µ–∫
          const parts = [];
          let currentPart = '';
          let inQuotes = false;
          
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ';' && !inQuotes) {
              parts.push(currentPart.trim());
              currentPart = '';
            } else {
              currentPart += char;
            }
          }
          parts.push(currentPart.trim());
          
          // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π
          const cleanParts = parts.map(part => part.replace(/^"|"$/g, ''));
          
          if (cleanParts.length >= 6) {
            const [dateStr, timeStr, exerciseName, setIndexStr, weightStr, repsStr] = cleanParts;
            
            if (!exerciseName || exerciseName === '') {
              skippedCount++;
              continue;
            }
            
            // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
            let date;
            try {
              // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç
              if (dateStr.includes('.')) {
                // –§–æ—Ä–º–∞—Ç DD.MM.YYYY
                const [day, month, year] = dateStr.split('.');
                date = new Date(year, month - 1, day);
                if (timeStr) {
                  const [hours, minutes] = timeStr.split(':');
                  date.setHours(parseInt(hours) || 0, parseInt(minutes) || 0);
                }
              } else if (dateStr.includes('-')) {
                // –§–æ—Ä–º–∞—Ç YYYY-MM-DD
                date = new Date(dateStr + 'T' + (timeStr || '00:00'));
              } else {
                // –ü—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
                date = new Date(dateStr + ' ' + timeStr);
              }
            } catch (e) {
              date = new Date();
            }
            
            if (isNaN(date.getTime())) {
              date = new Date();
            }
            
            const weight = parseFloat(weightStr.replace(',', '.')) || 0;
            const reps = parseInt(repsStr) || 0;
            
            if (weight > 0 && reps > 0 && exerciseName) {
              // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ —ç—Ç—É –¥–∞—Ç—É —Å —ç—Ç–∏–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ–º
              const existingIndex = newWorkouts.findIndex(w => 
                w.name === exerciseName && 
                Math.abs(new Date(w.date).getTime() - date.getTime()) < 24 * 60 * 60 * 1000
              );
              
              if (existingIndex >= 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ö–æ–¥ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
                newWorkouts[existingIndex].sets.push({ weight, reps });
                newWorkouts[existingIndex].volume += weight * reps;
              } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                const newWorkout = {
                  id: Date.now() + '-' + Math.random().toString(36).substr(2, 9) + '-' + i,
                  name: exerciseName,
                  sets: [{ weight, reps }],
                  date: date.getTime(),
                  volume: weight * reps,
                  userId: currentUser.id
                };
                newWorkouts.push(newWorkout);
              }
              
              // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
              if (!exercises.includes(exerciseName)) {
                exercises.push(exerciseName);
              }
              
              importedCount++;
            } else {
              skippedCount++;
            }
          }
        } catch (parseError) {
          console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏ ${i}:`, line, parseError);
          errors.push(`–°—Ç—Ä–æ–∫–∞ ${i}`);
          skippedCount++;
        }
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
      if (newWorkouts.length > 0) {
        appData.push(...newWorkouts);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        saveExercises();
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        saveData();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        renderExercises();
        renderHistory();
        
        showToast(`–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: ${importedCount} –ø–æ–¥—Ö–æ–¥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');
      } else {
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞', 'warning');
      }
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV:', error);
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV —Ñ–∞–π–ª–∞', 'error');
    } finally {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input —Ñ–∞–π–ª–∞
      event.target.value = '';
    }
  };
  
  reader.onerror = function() {
    showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
    event.target.value = '';
  };
  
  reader.readAsText(file, 'UTF-8');
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
function showStats() {
  const container = document.getElementById('statsContent');
  if (!container) return;
  
  if (!appData.length) {
    container.innerHTML = `
      <div class="empty-state">
        <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
      </div>
    `;
    document.getElementById('statsModal').classList.add('active');
    return;
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const totalWorkouts = appData.length;
  const totalExercises = [...new Set(appData.map(w => w.name))].length;
  const totalSets = appData.reduce((sum, w) => sum + w.sets.length, 0);
  const totalVolume = appData.reduce((sum, w) => sum + (w.volume || 0), 0);
  
  // –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
  const exerciseCounts = appData.reduce((acc, w) => {
    acc[w.name] = (acc[w.name] || 0) + 1;
    return acc;
  }, {});
  
  const popularExercises = Object.entries(exerciseCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  // –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  const firstWorkout = new Date(Math.min(...appData.map(w => w.date)));
  const daysSinceStart = Math.floor((Date.now() - firstWorkout) / (1000 * 60 * 60 * 24));
  
  // –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º
  const bestResults = {};
  appData.forEach(workout => {
    if (!bestResults[workout.name]) {
      bestResults[workout.name] = {
        maxWeight: 0,
        maxVolume: 0,
        totalSets: 0,
        totalWorkouts: 0
      };
    }
    
    const workoutBest = workout.sets.reduce((best, set) => {
      const weight = parseFloat(set.weight) || 0;
      const reps = parseInt(set.reps) || 0;
      const volume = weight * reps;
      
      return {
        maxWeight: Math.max(best.maxWeight, weight),
        maxVolume: Math.max(best.maxVolume, volume)
      };
    }, { maxWeight: 0, maxVolume: 0 });
    
    bestResults[workout.name].maxWeight = Math.max(
      bestResults[workout.name].maxWeight,
      workoutBest.maxWeight
    );
    bestResults[workout.name].maxVolume = Math.max(
      bestResults[workout.name].maxVolume,
      workoutBest.maxVolume
    );
    bestResults[workout.name].totalSets += workout.sets.length;
    bestResults[workout.name].totalWorkouts += 1;
  });
  
  const bestResultsList = Object.entries(bestResults)
    .sort((a, b) => b[1].maxWeight - a[1].maxWeight)
    .slice(0, 5);
  
  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userParams = userParameters[currentUser.id] || {};
  const bmi = userParams.height && userParams.weight ? 
    (userParams.weight / ((userParams.height/100) * (userParams.height/100))).toFixed(1) : '-';
  
  container.innerHTML = `
    <div class="profile-stats" style="margin: 0 0 20px 0;">
      <div class="profile-stat">
        <div class="profile-stat-value">${totalWorkouts}</div>
        <div class="profile-stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${totalExercises}</div>
        <div class="profile-stat-label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${totalSets}</div>
        <div class="profile-stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value">${Math.round(totalVolume)}</div>
        <div class="profile-stat-label">–∫–≥ –æ–±—â–∏–π –æ–±—ä–µ–º</div>
      </div>
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">üë§ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05);">
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–†–æ—Å—Ç:</span>
        <span style="font-weight: 600; color: ${userParams.height ? 'var(--primary)' : 'var(--text-secondary)'};">${userParams.height ? userParams.height + ' —Å–º' : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–í–µ—Å:</span>
        <span style="font-weight: 600; color: ${userParams.weight ? 'var(--primary)' : 'var(--text-secondary)'};">${userParams.weight ? userParams.weight + ' –∫–≥' : '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–ò–Ω–¥–µ–∫—Å –º–∞—Å—Å—ã —Ç–µ–ª–∞ (–ò–ú–¢):</span>
        <span style="font-weight: 600; color: ${bmi !== '-' ? 
          (bmi < 18.5 ? 'var(--warning)' : 
           bmi <= 24.9 ? 'var(--success)' : 
           bmi <= 29.9 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-secondary)'}">${bmi}</span>
      </div>
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">üèÜ –°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05);">
      ${popularExercises.map(([name, count], index) => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: ${index < popularExercises.length - 1 ? '1px solid var(--separator)' : 'none'};">
          <span>${index + 1}. ${name}</span>
          <span style="color: var(--primary); font-weight: 600;">${count} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span>
        </div>
      `).join('')}
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">üìà –õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.05);">
      ${bestResultsList.map(([name, stats], index) => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: ${index < bestResultsList.length - 1 ? '1px solid var(--separator)' : 'none'};">
          <span>${index + 1}. ${name}</span>
          <div style="text-align: right;">
            <div style="font-weight: 600; color: var(--primary);">${Math.round(stats.maxWeight)} –∫–≥</div>
            <div style="font-size: 11px; color: var(--text-secondary);">–º–∞–∫—Å. –≤–µ—Å</div>
          </div>
        </div>
      `).join('')}
    </div>
    
    <h3 style="margin: 20px 0 10px 0;">‚ÑπÔ∏è –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    <div style="background: var(--card-bg); border-radius: var(--radius); padding: 16px; border: 1px solid rgba(255, 255, 255, 0.05);">
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
        <span style="font-weight: 600; color: var(--primary);">${currentUser.name}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–ù–∞—á–∞–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:</span>
        <span>${firstWorkout.toLocaleDateString('ru-RU')}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–î–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:</span>
        <span>${daysSinceStart}</span>
      </div>
      <div style="display: flex; justify-content: space-between; padding: 8px 0;">
        <span>–°—Ä–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</span>
        <span>${Math.round(totalVolume / totalWorkouts)} –∫–≥</span>
      </div>
    </div>
  `;
  
  document.getElementById('statsModal').classList.add('active');
}

function closeStats() {
  document.getElementById('statsModal').classList.remove('active');
}

// –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function openUserProfile() {
  loadUserProfile();
  document.getElementById('profileModal').classList.add('active');
}

function closeUserProfile() {
  document.getElementById('profileModal').classList.remove('active');
}

function loadUserProfile() {
  const params = userParameters[currentUser.id] || { height: null, weight: null, history: [] };
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ UI
  document.getElementById('profileHeight').textContent = params.height ? params.height + ' —Å–º' : '- —Å–º';
  document.getElementById('profileWeight').textContent = params.weight ? params.weight + ' –∫–≥' : '- –∫–≥';
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ò–ú–¢
  let bmi = '-';
  if (params.height && params.weight) {
    bmi = (params.weight / ((params.height/100) * (params.height/100))).toFixed(1);
  }
  document.getElementById('profileIMC').textContent = bmi;
  
  // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
  const workoutCount = appData.length;
  document.getElementById('profileWorkouts').textContent = workoutCount;
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  document.getElementById('editHeight').value = params.height || '';
  document.getElementById('editWeight').value = params.weight || '';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
  loadParametersHistory();
  
  // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä–∞—Ñ–∏–∫
  renderParametersChart();
}

// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function saveUserParameters() {
  const heightInput = document.getElementById('editHeight');
  const weightInput = document.getElementById('editWeight');
  
  if (!heightInput || !weightInput) {
    showToast('–û—à–∏–±–∫–∞: –ø–æ–ª—è –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
    return;
  }
  
  const height = parseFloat(heightInput.value);
  const weight = parseFloat(weightInput.value);
  
  if ((height && (height < 100 || height > 250)) || (weight && (weight < 30 || weight > 200))) {
    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–æ—Å—Ç–∞ –∏–ª–∏ –≤–µ—Å–∞', 'error');
    return;
  }
  
  if (!userParameters[currentUser.id]) {
    userParameters[currentUser.id] = { height: null, weight: null, history: [] };
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const oldHeight = userParameters[currentUser.id].height;
  const oldWeight = userParameters[currentUser.id].weight;
  
  userParameters[currentUser.id].height = height || null;
  userParameters[currentUser.id].weight = weight || null;
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
  if ((height && height !== oldHeight) || (weight && weight !== oldWeight)) {
    if (!userParameters[currentUser.id].history) {
      userParameters[currentUser.id].history = [];
    }
    
    userParameters[currentUser.id].history.push({
      date: Date.now(),
      height: height || oldHeight,
      weight: weight || oldWeight
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    userParameters[currentUser.id].history.sort((a, b) => b.date - a.date);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 –∑–∞–ø–∏—Å—è–º–∏
    if (userParameters[currentUser.id].history.length > 100) {
      userParameters[currentUser.id].history = userParameters[currentUser.id].history.slice(0, 100);
    }
  }
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  saveUserParametersToStorage();
  loadUserProfile();
  
  showToast('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
}

function loadParametersHistory() {
  const container = document.getElementById('parametersHistory');
  if (!container) return;
  
  const params = userParameters[currentUser.id] || { history: [] };
  
  if (!params.history || params.history.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 20px;">
        <p>–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
        <p style="font-size: 12px; margin-top: 8px;">–î–æ–±–∞–≤—å—Ç–µ —Ä–æ—Å—Ç –∏ –≤–µ—Å –≤ –ø—Ä–æ—Ñ–∏–ª–µ</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = '';
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
  const grouped = params.history.reduce((groups, entry) => {
    const date = new Date(entry.date).toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
    
    if (!groups[date]) groups[date] = [];
    groups[date].push(entry);
    return groups;
  }, {});
  
  Object.entries(grouped).forEach(([date, entries]) => {
    const groupElement = document.createElement('div');
    groupElement.style.marginBottom = '15px';
    
    groupElement.innerHTML = `
      <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--primary);">${date}</div>
    `;
    
    entries.forEach(entry => {
      const time = new Date(entry.date).toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      const bmi = entry.height && entry.weight ? 
        (entry.weight / ((entry.height/100) * (entry.height/100))).toFixed(1) : '-';
      
      const entryElement = document.createElement('div');
      entryElement.style.cssText = `
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
      `;
      
      entryElement.innerHTML = `
        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
          <span style="font-size: 12px; color: var(--text-secondary);">${time}</span>
          <span style="font-size: 12px; color: var(--primary); font-weight: 600;">–ò–ú–¢: ${bmi}</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <div>
            <div style="font-size: 11px; color: var(--text-secondary);">–†–æ—Å—Ç</div>
            <div style="font-weight: 600;">${entry.height || '-'} —Å–º</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-secondary);">–í–µ—Å</div>
            <div style="font-weight: 600;">${entry.weight || '-'} –∫–≥</div>
          </div>
        </div>
      `;
      
      groupElement.appendChild(entryElement);
    });
    
    container.appendChild(groupElement);
  });
}

function renderParametersChart() {
  const canvas = document.getElementById('parametersChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const params = userParameters[currentUser.id] || { history: [] };
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É
  const cutoffDate = Date.now() - (chartPeriod * 24 * 60 * 60 * 1000);
  const filteredHistory = params.history.filter(entry => entry.date >= cutoffDate);
  
  if (filteredHistory.length < 2) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    const textSecondary = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
    ctx.fillStyle = textSecondary || '#8E8E93';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞', canvas.width/2, canvas.height/2);
    return;
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
  const sortedHistory = [...filteredHistory].sort((a, b) => a.date - b.date);
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  const dates = sortedHistory.map(entry => 
    new Date(entry.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })
  );
  
  const weights = sortedHistory.map(entry => entry.weight).filter(w => w);
  const heights = sortedHistory.map(entry => entry.height).filter(h => h);
  
  // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, —É–Ω–∏—á—Ç–æ–∂–∞–µ–º –µ–≥–æ
  if (parametersChart) {
    parametersChart.destroy();
  }
  
  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
  parametersChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [
        {
          label: '–í–µ—Å (–∫–≥)',
          data: weights,
          borderColor: 'rgb(10, 132, 255)',
          backgroundColor: 'rgba(10, 132, 255, 0.1)',
          tension: 0.3,
          fill: true
        },
        {
          label: '–†–æ—Å—Ç (—Å–º)',
          data: heights,
          borderColor: 'rgb(50, 215, 75)',
          backgroundColor: 'rgba(50, 215, 75, 0.1)',
          tension: 0.3,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: 'var(--text)',
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'var(--card-bg)',
          titleColor: 'var(--text)',
          bodyColor: 'var(--text)',
          borderColor: 'var(--separator)',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          ticks: {
            color: 'var(--text-secondary)',
            maxRotation: 45
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.05)'
          }
        },
        y: {
          ticks: {
            color: 'var(--text-secondary)'
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.05)'
          }
        }
      }
    }
  });
}

// –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function openUsersComparison() {
  renderUsersComparison();
  document.getElementById('comparisonModal').classList.add('active');
}

function closeUsersComparison() {
  document.getElementById('comparisonModal').classList.remove('active');
}

function renderUsersComparison() {
  const container = document.getElementById('comparisonContent');
  const exerciseSelect = document.getElementById('comparisonExercise');
  const selectedExercise = exerciseSelect ? exerciseSelect.value : '';
  
  if (!container) return;
  
  if (users.length < 2) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 40px 20px;">
        <p>–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
        <p style="font-size: 12px; margin-top: 8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏</p>
      </div>
    `;
    return;
  }
  
  // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userStats = users.map(user => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userAppData = loadUserData(user.id);
    const params = userParameters[user.id] || { height: null, weight: null };
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ
    let filteredData = userAppData;
    if (selectedExercise) {
      filteredData = userAppData.filter(item => item.name === selectedExercise);
    }
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const totalWorkouts = filteredData.length;
    const totalSets = filteredData.reduce((sum, w) => sum + w.sets.length, 0);
    const totalVolume = filteredData.reduce((sum, w) => sum + (w.volume || 0), 0);
    const avgVolume = totalWorkouts > 0 ? Math.round(totalVolume / totalWorkouts) : 0;
    
    // –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å –≤ –æ–¥–Ω–æ–º –ø–æ–¥—Ö–æ–¥–µ)
    let maxWeight = 0;
    filteredData.forEach(workout => {
      workout.sets.forEach(set => {
        const weight = parseFloat(set.weight) || 0;
        if (weight > maxWeight) maxWeight = weight;
      });
    });
    
    // –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
    const lastWorkout = filteredData.length > 0 ? 
      new Date(Math.max(...filteredData.map(w => w.date))).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) : 
      '–ù–µ—Ç';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ò–ú–¢
    let bmi = '-';
    if (params.height && params.weight) {
      bmi = (params.weight / ((params.height/100) * (params.height/100))).toFixed(1);
    }
    
    return {
      id: user.id,
      name: user.name,
      height: params.height,
      weight: params.weight,
      bmi: bmi,
      totalWorkouts,
      totalSets,
      totalVolume,
      avgVolume,
      maxWeight,
      lastWorkout
    };
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ–±—â–µ–º—É –æ–±—ä–µ–º—É (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
  userStats.sort((a, b) => b.totalVolume - a.totalVolume);
  
  // –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  let tableHTML = `
    <table class="comparison-table">
      <thead>
        <tr>
          <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
          <th>–†–æ—Å—Ç/–í–µ—Å</th>
          <th>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</th>
          <th>–û–±—ä–µ–º</th>
          <th>–ú–∞–∫—Å. –≤–µ—Å</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  userStats.forEach(stat => {
    const isCurrent = stat.id === currentUser.id;
    
    tableHTML += `
      <tr style="${isCurrent ? 'background: rgba(10, 132, 255, 0.1);' : ''}">
        <td>
          <div style="font-weight: ${isCurrent ? '600' : '400'}; color: ${isCurrent ? 'var(--primary)' : 'var(--text)'};">${stat.name}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">${stat.lastWorkout}</div>
        </td>
        <td>
          <div>${stat.height ? stat.height + ' —Å–º' : '-'}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">${stat.weight ? stat.weight + ' –∫–≥' : '-'}</div>
          <div style="font-size: 10px; color: ${stat.bmi !== '-' ? 
            (stat.bmi < 18.5 ? 'var(--warning)' : 
             stat.bmi <= 24.9 ? 'var(--success)' : 
             stat.bmi <= 29.9 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-secondary)'}">
            –ò–ú–¢: ${stat.bmi}
          </div>
        </td>
        <td class="comparison-value">${stat.totalWorkouts}</td>
        <td class="comparison-value">
          <div>${Math.round(stat.totalVolume)} –∫–≥</div>
          <div style="font-size: 11px; color: var(--text-secondary);">${stat.avgVolume} –∫–≥/—Ç—Ä.</div>
        </td>
        <td class="comparison-value">${Math.round(stat.maxWeight)} –∫–≥</td>
      </tr>
    `;
  });
  
  tableHTML += `
      </tbody>
    </table>
    
    <div style="margin-top: 20px; padding: 15px; background: rgba(10, 132, 255, 0.05); border-radius: var(--radius);">
      <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">üìä –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${userStats.length}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${userStats.reduce((sum, s) => sum + s.totalWorkouts, 0)}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${Math.round(userStats.reduce((sum, s) => sum + s.totalVolume, 0))}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">–û–±—â–∏–π –æ–±—ä–µ–º (–∫–≥)</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 18px; font-weight: 700; color: var(--primary);">${Math.round(Math.max(...userStats.map(s => s.maxWeight)))}</div>
          <div style="font-size: 11px; color: var(--text-secondary);">–†–µ–∫–æ—Ä–¥ –≤–µ—Å–∞</div>
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = tableHTML;
}

function loadUserData(userId) {
  try {
    const storageKey = `${STORAGE_KEY_PREFIX}_${userId}`;
    const storedAppData = localStorage.getItem(storageKey);
    if (storedAppData) {
      const parsed = JSON.parse(storedAppData);
      return Array.isArray(parsed) ? parsed : [];
    }
    return [];
  } catch (e) {
    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, e);
    return [];
  }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
function switchTab(tabId) {
  // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
  document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  if (!toast) return;
  
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
  let icon = '‚ÑπÔ∏è';
  if (type === 'success') icon = '‚úÖ';
  if (type === 'error') icon = '‚ùå';
  if (type === 'warning') icon = '‚ö†Ô∏è';
  
  toast.innerHTML = `${icon} ${message}`;
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
function initDOMCheck() {
  const requiredElements = [
    'userSelect',
    'exerciseSelect',
    'filterExercise',
    'setsContainer',
    'historyList',
    'saveBtn',
    'exerciseModal',
    'usersModal',
    'statsModal',
    'profileModal',
    'comparisonModal',
    'toast'
  ];
  
  let allExist = true;
  requiredElements.forEach(id => {
    if (!document.getElementById(id)) {
      console.error(`–≠–ª–µ–º–µ–Ω—Ç —Å id "${id}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
      allExist = false;
    }
  });
  
  return allExist;
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal')) {
    e.target.classList.remove('active');
  }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.querySelectorAll('.modal-card').forEach(card => {
  card.addEventListener('click', (e) => {
    e.stopPropagation();
  });
});

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', (e) => {
  // Ctrl+S –∏–ª–∏ Cmd+S –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveWorkout();
  }
  
  // Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      modal.classList.remove('active');
    });
  }
  
  // + –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–∞
  if (e.key === '+' && !e.ctrlKey && !e.metaKey) {
    e.preventDefault();
    addSet();
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–∞–π–ø–æ–≤ (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
});

document.addEventListener('touchend', (e) => {
  const touchEndX = e.changedTouches[0].screenX;
  const touchEndY = e.changedTouches[0].screenY;
  
  const diffX = touchEndX - touchStartX;
  const diffY = touchEndY - touchStartY;
  
  // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if (Math.abs(diffX) > 50 && Math.abs(diffY) < 30) {
    if (diffX > 0) {
      // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ
      const saveBtn = document.querySelector('.fab-container button');
      if (saveBtn) {
        saveBtn.style.transform = 'scale(0.95)';
        setTimeout(() => {
          saveBtn.style.transform = '';
          saveWorkout();
        }, 100);
      }
    }
  }
});

// –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è iPhone 13 Pro Max
function isIPhone13ProMax() {
  return /iPhone.*13.*Pro.*Max/.test(navigator.userAgent) || 
         (window.screen.width === 428 && window.screen.height === 926);
}

if (isIPhone13ProMax()) {
  console.log('iPhone 13 Pro Max detected - applying optimizations');
  
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
  document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
      @media only screen and (max-width: 430px) {
        .container {
          padding: 18px;
        }
        .header-sticky {
          padding: 14px 18px;
        }
        .fab-container {
          left: 18px;
          right: 18px;
        }
        .set-inputs input {
          font-size: 18px;
          padding: 12px;
        }
        .header-btn {
          width: 42px;
          height: 42px;
          font-size: 20px;
        }
      }
    `;
    document.head.appendChild(style);
  });
}
</script>
</body>
</html>
