<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–º–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            border: 1px solid #334155;
        }
        
        h1 {
            color: #60a5fa;
            margin-bottom: 5px;
            font-size: 1.5rem;
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .input-section {
            background: rgba(30, 41, 59, 0.7);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #334155;
        }
        
        .input-section h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resource-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .resource-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            border: 1px solid #475569;
        }
        
        .resource-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stone-icon { color: #94a3b8; }
        .wood-icon { color: #b45309; }
        .metal-icon { color: #d1d5db; }
        
        .resource-name {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #475569;
            border-radius: 6px;
            background: rgba(30, 41, 59, 0.9);
            color: white;
            font-size: 1rem;
            text-align: center;
            transition: all 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        .exchange-rates {
            background: rgba(15, 23, 42, 0.8);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #475569;
        }
        
        .rate-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-bottom: 5px;
        }
        
        .rate-item:last-child {
            margin-bottom: 0;
        }
        
        .results {
            background: rgba(30, 41, 59, 0.7);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid #334155;
            display: none;
        }
        
        .results.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .results h2 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .level-result {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #10b981;
        }
        
        .level-badge {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 5px;
        }
        
        .level-text {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .exchange-result {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #f59e0b;
        }
        
        .exchange-result h3 {
            color: #f59e0b;
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .exchange-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #334155;
        }
        
        .exchange-label {
            color: #cbd5e1;
            font-size: 0.9rem;
        }
        
        .exchange-value {
            color: #60a5fa;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .resource-result {
            background: rgba(15, 23, 42, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #60a5fa;
        }
        
        .resource-result h3 {
            color: #60a5fa;
            margin-bottom: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .resource-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .resource-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
        }
        
        .resource-amount {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f8fafc;
            margin-top: 5px;
        }
        
        .resource-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #ef4444;
            text-align: center;
            color: #fca5a5;
            font-size: 0.9rem;
        }
        
        .info-message {
            background: rgba(96, 165, 250, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #60a5fa;
            text-align: center;
            color: #93c5fd;
            font-size: 0.9rem;
        }
        
        footer {
            margin-top: 20px;
            text-align: center;
            color: #64748b;
            font-size: 0.75rem;
            padding: 10px;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .resource-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .resource-item {
                flex-direction: row;
                justify-content: space-between;
                padding: 10px 15px;
            }
            
            .resource-icon {
                margin-bottom: 0;
                margin-right: 10px;
                font-size: 1.8rem;
            }
            
            .resource-name {
                margin-bottom: 0;
                margin-right: 10px;
                font-size: 0.9rem;
                min-width: 60px;
                text-align: left;
            }
            
            input {
                max-width: 120px;
                margin-left: auto;
            }
            
            .resource-row {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .resource-cell {
                padding: 8px;
            }
            
            .resource-amount {
                font-size: 1rem;
            }
            
            .resource-label {
                font-size: 0.7rem;
            }
        }
        
        /* –ü–ª–∞–Ω—à–µ—Ç—ã –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
        @media (min-width: 481px) and (max-width: 768px) {
            .resource-inputs {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            
            .resource-item {
                padding: 15px 10px;
            }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è placeholder */
        input::placeholder {
            color: #64748b;
            transition: color 0.2s;
        }
        
        input:focus::placeholder {
            color: #94a3b8;
        }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è WebKit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–æ–∫–∞—á–∫–∏ –∑–∞–º–∫–∞</h1>
            <p class="subtitle">–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã - —Ä–∞—Å—á–µ—Ç –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
        </header>
        
        <div class="input-section">
            <h2>üì¶ –í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã</h2>
            <div class="resource-inputs">
                <div class="resource-item">
                    <div class="resource-icon stone-icon">‚õ∞Ô∏è</div>
                    <div class="resource-name">–ö–∞–º–µ–Ω—å</div>
                    <input 
                        type="number" 
                        id="stoneInput" 
                        placeholder="0" 
                        min="0" 
                        inputmode="numeric"
                        autocomplete="off"
                    >
                </div>
                <div class="resource-item">
                    <div class="resource-icon wood-icon">üå≤</div>
                    <div class="resource-name">–î–µ—Ä–µ–≤–æ</div>
                    <input 
                        type="number" 
                        id="woodInput" 
                        placeholder="0" 
                        min="0" 
                        inputmode="numeric"
                        autocomplete="off"
                    >
                </div>
                <div class="resource-item">
                    <div class="resource-icon metal-icon">‚öôÔ∏è</div>
                    <div class="resource-name">–ú–µ—Ç–∞–ª–ª</div>
                    <input 
                        type="number" 
                        id="metalInput" 
                        placeholder="0" 
                        min="0" 
                        inputmode="numeric"
                        autocomplete="off"
                    >
                </div>
            </div>
            
            <div class="exchange-rates">
                <div class="rate-item">
                    <span>1 üå≤ = 5 ‚õ∞Ô∏è</span>
                    <span style="color: #94a3b8; font-size: 0.8rem;">(1 –¥–µ—Ä–µ–≤–æ = 5 –∫–∞–º–Ω—è)</span>
                </div>
                <div class="rate-item">
                    <span>1 ‚öôÔ∏è = 4 üå≤</span>
                    <span style="color: #94a3b8; font-size: 0.8rem;">(1 –º–µ—Ç–∞–ª–ª = 4 –¥–µ—Ä–µ–≤–∞)</span>
                </div>
            </div>
        </div>
        
        <div class="results" id="results">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>
            
            <div class="level-result">
                <div class="level-badge" id="maxLevelsBadge">0</div>
                <div class="level-text">—É—Ä–æ–≤–Ω–µ–π –∑–∞–º–∫–∞ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å</div>
            </div>
            
            <div class="exchange-result">
                <h3>üîÑ –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ–±–º–µ–Ω—ã</h3>
                <div class="exchange-row">
                    <span class="exchange-label">–ö–∞–º–µ–Ω—å ‚Üí –î–µ—Ä–µ–≤–æ:</span>
                    <span class="exchange-value" id="stoneToWood">0 –¥–µ—Ä–µ–≤–∞ (0 –∫–∞–º–Ω—è)</span>
                </div>
                <div class="exchange-row">
                    <span class="exchange-label">–î–µ—Ä–µ–≤–æ ‚Üí –ú–µ—Ç–∞–ª–ª:</span>
                    <span class="exchange-value" id="woodToMetal">0 –º–µ—Ç–∞–ª–ª–∞ (0 –¥–µ—Ä–µ–≤–∞)</span>
                </div>
                <div class="exchange-row">
                    <span class="exchange-label">–í—Å–µ–≥–æ –∫–∞–º–Ω—è –Ω–∞ –æ–±–º–µ–Ω—ã:</span>
                    <span class="exchange-value" id="totalStoneCost">0</span>
                </div>
            </div>
            
            <div class="resource-result">
                <h3>üìà –†–µ—Å—É—Ä—Å—ã –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏—è</h3>
                <div class="resource-row">
                    <div class="resource-cell">
                        <div class="resource-icon stone-icon">‚õ∞Ô∏è</div>
                        <div class="resource-amount" id="stoneAfter">0</div>
                        <div class="resource-label">–ö–∞–º–Ω—è</div>
                    </div>
                    <div class="resource-cell">
                        <div class="resource-icon wood-icon">üå≤</div>
                        <div class="resource-amount" id="woodAfter">0</div>
                        <div class="resource-label">–î–µ—Ä–µ–≤–∞</div>
                    </div>
                    <div class="resource-cell">
                        <div class="resource-icon metal-icon">‚öôÔ∏è</div>
                        <div class="resource-amount" id="metalAfter">0</div>
                        <div class="resource-label">–ú–µ—Ç–∞–ª–ª–∞</div>
                    </div>
                </div>
            </div>
            
            <div id="message"></div>
        </div>
        
        <footer>
            <p>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å: 1260 –∫–∞–º–Ω—è, 340 –¥–µ—Ä–µ–≤–∞, 130 –º–µ—Ç–∞–ª–ª–∞</p>
            <p>–û–±–º–µ–Ω —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É: –∫–∞–º–µ–Ω—å ‚Üí –¥–µ—Ä–µ–≤–æ ‚Üí –º–µ—Ç–∞–ª–ª</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            const stoneInput = document.getElementById('stoneInput');
            const woodInput = document.getElementById('woodInput');
            const metalInput = document.getElementById('metalInput');
            const resultsDiv = document.getElementById('results');
            
            // –¢—Ä–µ–±—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å
            const STONE_PER_LEVEL = 1260;
            const WOOD_PER_LEVEL = 340;
            const METAL_PER_LEVEL = 130;
            
            // –ö—É—Ä—Å—ã –æ–±–º–µ–Ω–∞
            const WOOD_FROM_STONE = 5; // 1 –¥–µ—Ä–µ–≤–æ = 5 –∫–∞–º–Ω—è
            const METAL_FROM_WOOD = 4; // 1 –º–µ—Ç–∞–ª–ª = 4 –¥–µ—Ä–µ–≤–∞
            
            // –§–ª–∞–≥–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–≤–æ–¥–æ–º
            let isCalculating = false;
            let debounceTimer = null;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            stoneInput.value = '';
            woodInput.value = '';
            metalInput.value = '';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            [stoneInput, woodInput, metalInput].forEach(input => {
                // –°–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è
                input.addEventListener('input', function() {
                    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    if (debounceTimer) {
                        clearTimeout(debounceTimer);
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∞
                    debounceTimer = setTimeout(() => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                        const value = parseInt(this.value) || 0;
                        if (value < 0) {
                            this.value = 0;
                        }
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á–µ—Ç
                        calculate();
                    }, 300);
                });
                
                // –°–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
                input.addEventListener('blur', function() {
                    const value = parseInt(this.value) || 0;
                    this.value = value; // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª—É
                    calculate();
                });
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–≤–æ–¥ –±—É–∫–≤ –∏ —Å–∏–º–≤–æ–ª–æ–≤
                input.addEventListener('keydown', function(e) {
                    // –†–∞–∑—Ä–µ—à–∞–µ–º: —Ü–∏—Ñ—Ä—ã, backspace, delete, tab, —Å—Ç—Ä–µ–ª–∫–∏
                    if (
                        (e.key >= '0' && e.key <= '9') ||
                        e.key === 'Backspace' ||
                        e.key === 'Delete' ||
                        e.key === 'Tab' ||
                        e.key === 'ArrowLeft' ||
                        e.key === 'ArrowRight' ||
                        e.key === 'ArrowUp' ||
                        e.key === 'ArrowDown'
                    ) {
                        return;
                    }
                    
                    // –†–∞–∑—Ä–µ—à–∞–µ–º Ctrl/Cmd + A, C, V, X
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'a' || e.key === 'A' ||
                            e.key === 'c' || e.key === 'C' ||
                            e.key === 'v' || e.key === 'V' ||
                            e.key === 'x' || e.key === 'X') {
                            return;
                        }
                    }
                    
                    // –ó–∞–ø—Ä–µ—â–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
                    e.preventDefault();
                });
            });
            
            // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
            function calculate() {
                if (isCalculating) return;
                isCalculating = true;
                
                // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
                const stone = parseInt(stoneInput.value) || 0;
                const wood = parseInt(woodInput.value) || 0;
                const metal = parseInt(metalInput.value) || 0;
                
                // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ, —Å–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (stone === 0 && wood === 0 && metal === 0) {
                    resultsDiv.classList.remove('active');
                    isCalculating = false;
                    return;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                resultsDiv.classList.add('active');
                
                try {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π
                    const result = calculateMaxLevelsWithExchanges(stone, wood, metal);
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    displayResults(result);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:', error);
                    showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ');
                }
                
                isCalculating = false;
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Ä–æ–≤–Ω–µ–π —Å —É—á–µ—Ç–æ–º –æ–±–º–µ–Ω–æ–≤
            function calculateMaxLevelsWithExchanges(stone, wood, metal) {
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π (–æ–≥—Ä–∞–Ω–∏—á–∏–º 100)
                let maxLevels = 0;
                
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–≤–Ω–µ–π
                for (let levels = 1; levels <= 100; levels++) {
                    const neededStone = STONE_PER_LEVEL * levels;
                    const neededWood = WOOD_PER_LEVEL * levels;
                    const neededMetal = METAL_PER_LEVEL * levels;
                    
                    // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
                    let currentStone = stone;
                    let currentWood = wood;
                    let currentMetal = metal;
                    
                    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±–º–µ–Ω–æ–≤
                    let stoneToWoodExchange = 0;
                    let woodToMetalExchange = 0;
                    let totalStoneSpent = 0;
                    
                    // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –º–µ—Ç–∞–ª–ª —á–µ—Ä–µ–∑ –æ–±–º–µ–Ω—ã
                    if (currentMetal < neededMetal) {
                        const missingMetal = neededMetal - currentMetal;
                        const woodNeededForMetal = missingMetal * METAL_FROM_WOOD;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –¥–µ—Ä–µ–≤–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–ª–ª–∞
                        if (currentWood >= woodNeededForMetal) {
                            // –•–≤–∞—Ç–∞–µ—Ç –¥–µ—Ä–µ–≤–∞
                            currentWood -= woodNeededForMetal;
                            currentMetal += missingMetal;
                            woodToMetalExchange += missingMetal;
                        } else {
                            // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ—Ä–µ–≤–∞, –ø–æ–ª—É—á–∞–µ–º –¥–µ—Ä–µ–≤–æ –∏–∑ –∫–∞–º–Ω—è
                            const missingWood = woodNeededForMetal - currentWood;
                            const stoneNeededForWood = missingWood * WOOD_FROM_STONE;
                            
                            if (currentStone >= stoneNeededForWood) {
                                // –•–≤–∞—Ç–∞–µ—Ç –∫–∞–º–Ω—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞
                                currentStone -= stoneNeededForWood;
                                currentWood += missingWood; // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ä–µ–≤–æ
                                currentWood -= woodNeededForMetal; // –¢—Ä–∞—Ç–∏–º –¥–µ—Ä–µ–≤–æ –Ω–∞ –º–µ—Ç–∞–ª–ª
                                currentMetal += missingMetal; // –ü–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–ª–ª
                                
                                stoneToWoodExchange += missingWood;
                                woodToMetalExchange += missingMetal;
                                totalStoneSpent += stoneNeededForWood;
                            } else {
                                // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞–º–Ω—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –º–µ—Ç–∞–ª–ª–∞
                                break;
                            }
                        }
                    }
                    
                    // –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –¥–µ—Ä–µ–≤–æ —á–µ—Ä–µ–∑ –æ–±–º–µ–Ω—ã
                    if (currentWood < neededWood) {
                        const missingWood = neededWood - currentWood;
                        const stoneNeededForWood = missingWood * WOOD_FROM_STONE;
                        
                        if (currentStone >= stoneNeededForWood) {
                            // –•–≤–∞—Ç–∞–µ—Ç –∫–∞–º–Ω—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞
                            currentStone -= stoneNeededForWood;
                            currentWood += missingWood;
                            stoneToWoodExchange += missingWood;
                            totalStoneSpent += stoneNeededForWood;
                        } else {
                            // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞–º–Ω—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞
                            break;
                        }
                    }
                    
                    // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –∫–∞–º–Ω—è
                    if (currentStone >= neededStone) {
                        // –£—Å–ø–µ—Ö! –í—ã—á–∏—Ç–∞–µ–º –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∫–∞–º–µ–Ω—å
                        currentStone -= neededStone;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        maxLevels = levels;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞—Å—á–µ—Ç–µ
                        result = {
                            levels: levels,
                            stoneToWood: stoneToWoodExchange,
                            woodToMetal: woodToMetalExchange,
                            totalStoneSpent: totalStoneSpent,
                            remainingStone: currentStone,
                            remainingWood: currentWood,
                            remainingMetal: currentMetal,
                            requiredStone: neededStone,
                            requiredWood: neededWood,
                            requiredMetal: neededMetal
                        };
                    } else {
                        // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫–∞–º–Ω—è
                        break;
                    }
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –Ω—É–ª–µ–≤–æ–π
                return result || {
                    levels: 0,
                    stoneToWood: 0,
                    woodToMetal: 0,
                    totalStoneSpent: 0,
                    remainingStone: stone,
                    remainingWood: wood,
                    remainingMetal: metal,
                    requiredStone: 0,
                    requiredWood: 0,
                    requiredMetal: 0
                };
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            function displayResults(result) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å —É—Ä–æ–≤–Ω—è–º–∏
                const maxLevelsBadge = document.getElementById('maxLevelsBadge');
                maxLevelsBadge.textContent = result.levels;
                
                if (result.levels > 0) {
                    maxLevelsBadge.style.color = '#10b981';
                } else {
                    maxLevelsBadge.style.color = '#ef4444';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–º–µ–Ω–∞—Ö
                document.getElementById('stoneToWood').textContent = 
                    `${result.stoneToWood} –¥–µ—Ä–µ–≤–∞ (${result.stoneToWood * WOOD_FROM_STONE} –∫–∞–º–Ω—è)`;
                
                document.getElementById('woodToMetal').textContent = 
                    `${result.woodToMetal} –º–µ—Ç–∞–ª–ª–∞ (${result.woodToMetal * METAL_FROM_WOOD} –¥–µ—Ä–µ–≤–∞)`;
                
                document.getElementById('totalStoneCost').textContent = 
                    `${result.totalStoneSpent} –∫–∞–º–Ω—è`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
                document.getElementById('stoneAfter').textContent = result.remainingStone;
                document.getElementById('woodAfter').textContent = result.remainingWood;
                document.getElementById('metalAfter').textContent = result.remainingMetal;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                const messageElement = document.getElementById('message');
                messageElement.innerHTML = '';
                messageElement.className = '';
                
                if (result.levels === 0) {
                    // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–∞–∂–µ –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å
                    messageElement.className = 'error-message';
                    
                    const stone = parseInt(stoneInput.value) || 0;
                    const wood = parseInt(woodInput.value) || 0;
                    const metal = parseInt(metalInput.value) || 0;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º, —á–µ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
                    let missingStone = Math.max(0, STONE_PER_LEVEL - stone);
                    let missingWood = Math.max(0, WOOD_PER_LEVEL - wood);
                    let missingMetal = Math.max(0, METAL_PER_LEVEL - metal);
                    
                    // –£—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±–º–µ–Ω–∞
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ –æ–±–º–µ–Ω
                    if (missingMetal > 0) {
                        const woodForMetal = missingMetal * METAL_FROM_WOOD;
                        if (wood + Math.floor(stone / WOOD_FROM_STONE) >= woodForMetal) {
                            // –ú–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–ª–ª —á–µ—Ä–µ–∑ –æ–±–º–µ–Ω
                            missingMetal = 0;
                        }
                    }
                    
                    if (missingWood > 0) {
                        const stoneForWood = missingWood * WOOD_FROM_STONE;
                        if (stone >= stoneForWood) {
                            // –ú–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ä–µ–≤–æ —á–µ—Ä–µ–∑ –æ–±–º–µ–Ω
                            missingWood = 0;
                        }
                    }
                    
                    let message = '‚ùå –†–µ—Å—É—Ä—Å–æ–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∑–∞–º–∫–∞.<br>';
                    
                    if (missingStone > 0 || missingWood > 0 || missingMetal > 0) {
                        message += '<br><strong>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç:</strong><br>';
                        if (missingStone > 0) message += `‚Ä¢ ${missingStone} –∫–∞–º–Ω—è<br>`;
                        if (missingWood > 0) message += `‚Ä¢ ${missingWood} –¥–µ—Ä–µ–≤–∞<br>`;
                        if (missingMetal > 0) message += `‚Ä¢ ${missingMetal} –º–µ—Ç–∞–ª–ª–∞<br>`;
                    }
                    
                    messageElement.innerHTML = message;
                } else {
                    // –†–µ—Å—É—Ä—Å–æ–≤ —Ö–≤–∞—Ç–∞–µ—Ç
                    messageElement.className = 'info-message';
                    
                    let message = '‚úÖ –†–µ—Å—É—Ä—Å–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!<br><br>';
                    message += `<strong>–ù–∞ ${result.levels} ${getLevelWord(result.levels)} –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:</strong><br>`;
                    message += `‚Ä¢ ${result.requiredStone} –∫–∞–º–Ω—è<br>`;
                    message += `‚Ä¢ ${result.requiredWood} –¥–µ—Ä–µ–≤–∞<br>`;
                    message += `‚Ä¢ ${result.requiredMetal} –º–µ—Ç–∞–ª–ª–∞<br>`;
                    
                    if (result.stoneToWood > 0 || result.woodToMetal > 0) {
                        message += '<br><strong>–û–±–º–µ–Ω—ã:</strong><br>';
                        if (result.stoneToWood > 0) {
                            message += `‚Ä¢ ${result.stoneToWood * WOOD_FROM_STONE} –∫–∞–º–Ω—è ‚Üí ${result.stoneToWood} –¥–µ—Ä–µ–≤–∞<br>`;
                        }
                        if (result.woodToMetal > 0) {
                            message += `‚Ä¢ ${result.woodToMetal * METAL_FROM_WOOD} –¥–µ—Ä–µ–≤–∞ ‚Üí ${result.woodToMetal} –º–µ—Ç–∞–ª–ª–∞<br>`;
                        }
                    }
                    
                    messageElement.innerHTML = message;
                }
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
                if (window.innerWidth < 768) {
                    setTimeout(() => {
                        resultsDiv.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest',
                            inline: 'start'
                        });
                    }, 100);
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "—É—Ä–æ–≤–µ–Ω—å"
            function getLevelWord(level) {
                if (level % 10 === 1 && level % 100 !== 11) return '—É—Ä–æ–≤–Ω—è';
                if ([2, 3, 4].includes(level % 10) && ![12, 13, 14].includes(level % 100)) return '—É—Ä–æ–≤–Ω–µ–π';
                return '—É—Ä–æ–≤–Ω–µ–π';
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
            function showError(message) {
                const messageElement = document.getElementById('message');
                messageElement.className = 'error-message';
                messageElement.innerHTML = `‚ùå ${message}`;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ URL, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
            function loadFromURL() {
                const params = new URLSearchParams(window.location.search);
                const stone = params.get('stone');
                const wood = params.get('wood');
                const metal = params.get('metal');
                
                if (stone !== null) stoneInput.value = stone;
                if (wood !== null) woodInput.value = wood;
                if (metal !== null) metalInput.value = metal;
                
                if (stone !== null || wood !== null || metal !== null) {
                    calculate();
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ URL –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            function saveToURL() {
                const stone = parseInt(stoneInput.value) || 0;
                const wood = parseInt(woodInput.value) || 0;
                const metal = parseInt(metalInput.value) || 0;
                
                const params = new URLSearchParams();
                if (stone > 0) params.set('stone', stone);
                if (wood > 0) params.set('wood', wood);
                if (metal > 0) params.set('metal', metal);
                
                const newURL = `${window.location.pathname}?${params.toString()}`;
                window.history.replaceState({}, '', newURL);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ
            const originalCalculate = calculate;
            calculate = function() {
                originalCalculate();
                saveToURL();
            };
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadFromURL();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.addEventListener('pageshow', loadFromURL);
        });
    </script>
</body>
</html>